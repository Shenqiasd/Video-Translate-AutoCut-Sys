<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1200" />
  <title>KrillinAI</title>

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" />

  <style>
    /* Page-specific overrides and legacy compatibility styles */
    body {
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: linear-gradient(120deg, #020E19 0%, #0A1628 100%);
      min-height: 100vh;
      color: #E8E9F5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .card {
      background: rgba(35, 44, 56, 0.9);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid #2E3A4B;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #FFFFFF;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
    }

    .card-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 2px;
      margin-right: 12px;
    }

    .form-group {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-group label {
      min-width: 200px;
      text-align: left;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 16px;
    }

    .form-label {
      font-weight: 600;
      color: #B8C3D1;
      min-width: 120px;
      text-align: right;
    }

    .form-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #2E3A4B;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #151A23;
      color: #FFFFFF;
    }

    .form-input:focus {
      outline: none;
      border-color: #1690FF;
      box-shadow: 0 0 0 2px rgba(22, 144, 255, 0.2);
    }

    .form-select {
      padding: 10px 14px;
      border: 1px solid #2E3A4B;
      border-radius: 8px;
      font-size: 14px;
      background: #151A23;
      color: #FFFFFF;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: #1690FF;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-item,
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    .radio-item input,
    .checkbox-item input {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
    }

    .hidden {
      display: none !important;
    }

    .action-area {
      text-align: center;
      margin: 32px 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      transition: all 0.1s;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-primary.clicked {
      animation: button-click 0.5s;
    }

    @keyframes button-click {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(0.95);
      }

      100% {
        transform: scale(1);
      }
    }

    .progress-section {
      margin-top: 24px;
      padding: 20px;
      background: rgba(236, 244, 255, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .progress-section h4 {
      margin: 0 0 12px 0;
      color: #1e293b;
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
      transition: width 0.3s ease;
      min-width: 40px;
    }

    .download-links {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .download-links a {
      padding: 8px 16px;
      background: #f8fafc;
      color: #3b82f6;
      text-decoration: none;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .download-links a:hover {
      background: #eff6ff;
      border-color: #3b82f6;
      transform: translateY(-1px);
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #059669;
      font-weight: 500;
    }

    .loading::after {
      content: "";
      width: 16px;
      height: 16px;
      border: 2px solid #059669;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
    }

    .app-container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 300px;
      background: rgba(28, 34, 45, 0.95);
      box-shadow: 2px 0 16px 0 rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 0 0 0;
      border-top-right-radius: 24px;
      border-bottom-right-radius: 24px;
      backdrop-filter: blur(12px);
      border-right: 1px solid #2E3A4B;
    }

    .logo {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      color: #1690FF;
      margin-bottom: 16px;
      letter-spacing: 2px;
    }

    .slogan {
      font-size: 1rem;
      color: #B8C3D1;
      margin-bottom: 32px;
      text-align: center;
      word-wrap: break-word;
      line-height: 1.4;
      padding: 0 16px;
    }

    .nav {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: auto;
    }

    .nav-btn {
      width: 90%;
      margin: 0 auto;
      padding: 14px 0;
      border: none;
      border-radius: 10px;
      background: none;
      font-size: 1.1rem;
      color: #E8E9F5;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .nav-btn.active,
    .nav-btn:hover {
      background: linear-gradient(90deg, #1690FF 60%, #60a5fa 100%);
      color: #fff;
    }

    .sidebar-bottom {
      margin: 32px 0 0 0;
      width: 100%;
      text-align: center;
    }

    .main-content {
      flex: 1;
      padding: 40px 0 0 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: transparent;
      overflow: hidden;
    }

    .main-inner {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      height: calc(100vh - 120px);
      background: rgba(35, 44, 56, 0.95);
      border-radius: 18px;
      box-shadow: 0 4px 32px 0 rgba(0, 0, 0, 0.3);
      padding: 0;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(8px);
      overflow: hidden;
    }

    #page-workbench,
    #page-config,
    #llm-config {
      flex: 1;
      padding: 36px 48px 24px 48px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
      /* ä¸ºçŠ¶æ€æ é¢„ç•™ç©ºé—´ï¼Œé¿å…å†…å®¹è¢«é®æŒ¡ */
      padding-bottom: 60px;
    }

    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    #page-workbench::-webkit-scrollbar,
    #page-config::-webkit-scrollbar,
    #llm-config::-webkit-scrollbar {
      width: 8px;
    }

    #page-workbench::-webkit-scrollbar-track,
    #page-config::-webkit-scrollbar-track,
    #llm-config::-webkit-scrollbar-track {
      background: rgba(21, 26, 35, 0.5);
      border-radius: 4px;
    }

    #page-workbench::-webkit-scrollbar-thumb,
    #page-config::-webkit-scrollbar-thumb,
    #llm-config::-webkit-scrollbar-thumb {
      background: rgba(58, 72, 93, 0.5);
      border-radius: 4px;
    }

    #page-workbench::-webkit-scrollbar-thumb:hover,
    #page-config::-webkit-scrollbar-thumb:hover,
    #llm-config::-webkit-scrollbar-thumb:hover {
      background: rgba(133, 153, 177, 0.7);
    }

    .status-bar {
      width: 100%;
      height: 38px;
      background: rgba(21, 26, 35, 0.95);
      color: #B8C3D1;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: first baseline;
      padding: 0 24px;
      border-top: 1px solid #2E3A4B;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.2);
      overflow: visible;
      white-space: nowrap;
      min-width: 0;
      box-sizing: border-box;
    }

    @media (max-width: 1200px) {
      .main-inner {
        padding: 24px 8px;
      }

      .sidebar {
        width: 180px;
      }

      .status-bar {
        font-size: 0.8rem;
        padding: 0 20px;
      }

      #page-workbench,
      #page-config {
        padding-bottom: 50px;
      }
    }

    @media (max-width: 900px) {
      .main-inner {
        padding: 8px 2px;
      }

      .sidebar {
        display: none;
      }

      .status-bar {
        font-size: 0.75rem;
        padding: 0 16px;
        height: 32px;
      }

      #page-workbench,
      #page-config {
        padding-bottom: 40px;
      }
    }

    @media (max-width: 600px) {
      .status-bar {
        font-size: 0.7rem;
        padding: 0 12px;
        height: 28px;
      }

      #page-workbench,
      #page-config {
        padding-bottom: 35px;
      }
    }

    #bilingual-position {
      min-width: 350px;
      width: auto;
    }

    #embed-subtitle {
      min-width: 350px;
      width: auto;
    }

    /* å¡ç‰‡å‰¯æ ‡é¢˜ */
    .card-subtitle {
      color: #6b7280;
      font-size: 0.9rem;
      margin: -10px 0 20px 0;
    }

    /* API ä¾›åº”å•†ç½‘æ ¼ */
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    /* ä¾›åº”å•†å¡ç‰‡ */
    .provider-card {
      background: #232C38;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #2E3A4B;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .provider-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      border-width: 3px;
    }

    .provider-card.qwen {
      border-color: #6336e7;
    }

    .provider-card.qwen:hover {
      border-color: #6336e7;
      background: rgba(99, 54, 231, 0.05);
    }

    .provider-card.openai {
      border-color: #74c365;
    }

    .provider-card.openai:hover {
      border-color: #74c365;
      background: rgba(116, 195, 101, 0.05);
    }

    .provider-card.deepseek {
      border-color: #4d6bfe;
    }

    .provider-card.deepseek:hover {
      border-color: #4d6bfe;
      background: rgba(77, 107, 254, 0.05);
    }

    .provider-icon {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
      color: #6b7280;
    }

    .provider-card .provider-icon img {
      filter: none;
    }

    .provider-card.openai .provider-icon {
      color: #74c365;
    }

    .provider-card.qwen .provider-icon {
      color: #6336e7;
    }

    .provider-card.deepseek .provider-icon {
      color: #4d6bfe;
    }

    .provider-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
      text-align: center;
    }

    .provider-desc {
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
    }

    /* ä½¿ç”¨æŒ‡å—æ ·å¼ */
    .guide-content {
      background: rgba(21, 26, 35, 0.8);
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #2E3A4B;
    }

    .guide-content h4 {
      color: #3b82f6;
      font-size: 1rem;
      font-weight: 600;
      margin: 16px 0 8px 0;
    }

    .guide-content h4:first-child {
      margin-top: 0;
    }

    .guide-content ul {
      margin: 0 0 12px 0;
      padding-left: 20px;
    }

    .guide-content li {
      margin-bottom: 4px;
      color: #B8C3D1;
      line-height: 1.5;
    }

    .guide-content code {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: "Monaco", "Consolas", monospace;
      font-size: 0.85rem;
      user-select: all;
    }

    .guide-content code:hover {
      background: rgba(59, 130, 246, 0.15);
    }

    /* Smart Clipper Styles */
    .clip-card {
      background: rgba(28, 34, 45, 0.6);
      border: 1px solid #3A4859;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .clip-card:hover {
      background: rgba(44, 53, 66, 0.8);
      border-color: #1690FF;
    }

    .clip-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .clip-title {
      font-weight: 600;
      color: #E8E9F5;
      flex: 1;
      font-size: 1.05rem;
    }

    .clip-duration {
      font-size: 0.85rem;
      background: #1A2332;
      padding: 2px 8px;
      border-radius: 4px;
      color: #60a5fa;
    }

    .clip-summary {
      font-size: 0.95rem;
      color: #B8C3D1;
      margin-bottom: 6px;
      padding-left: 28px;
    }

    .clip-reason {
      font-size: 0.85rem;
      color: #64748b;
      padding-left: 28px;
      font-style: italic;
    }

    .clip-checkbox {
      width: 18px;
      height: 18px;
      accent-color: #1690FF;
      cursor: pointer;
    }

    /* V2 UI Styles */
    .tabs-nav {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      border-bottom: 2px solid #2E3A4B;
      padding-bottom: 0;
    }

    .tab-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: #B8C3D1;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: -2px;
    }

    .tab-btn:hover {
      color: #3b82f6;
    }

    .tab-btn.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    /* History View Overrides to remove gaps */
    /* History View Overrides to remove gaps */
    body.history-mode .main-content {
      padding-top: 0 !important;
    }

    body.history-mode .main-inner {
      height: 98vh !important;
      margin-top: 1vh !important;
    }

    #page-workbench.history-view {
      padding: 0 48px 24px 48px !important;
      gap: 0 !important;
    }

    #page-workbench.history-view #page-title {
      display: none !important;
    }

    #page-workbench.history-view .tabs-nav {
      margin-bottom: 0 !important;
      padding-top: 16px;
      /* Add slight top padding for tabs so they don't touch browser edge */
      background: rgba(35, 44, 56, 0.98);
      /* Ensure background for sticky effect if needed */
      position: sticky;
      top: 0;
      z-index: 10;
      width: 100%;
      backdrop-filter: blur(8px);
    }

    .task-card {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      gap: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .task-cover {
      width: 120px;
      height: 68px;
      border-radius: 8px;
      background: #f1f5f9;
      object-fit: cover;
      flex-shrink: 0;
    }

    .task-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
      /* Enable truncation */
    }

    .task-title {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 14px;
    }

    .task-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: #64748b;
    }

    .task-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      color: #64748b;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .icon-btn:hover {
      background: #f8fafc;
      color: #3b82f6;
      border-color: #3b82f6;
    }

    .icon-btn.delete:hover {
      color: #ef4444;
      border-color: #ef4444;
      background: #fef2f2;
    }

    .status-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .copy-btn {
      font-size: 11px;
      color: #3b82f6;
      background: #eff6ff;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 8px;
    }

    .copy-btn:hover {
      background: #dbeafe;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="sidebar">
      <div class="logo">KrillinAI</div>
      <div class="slogan">AI Video Translation & Dubbing by Krillin AI</div>
      <div class="nav">
        <button class="nav-btn active" id="nav-workbench">
          å·¥ä½œå° Dashboard
        </button>
        <button class="nav-btn" id="nav-smart-clipper">
          æ™ºèƒ½åˆ‡ç‰‡ Smart Clipper âœ‚ï¸
        </button>
        <button class="nav-btn" id="nav-llm-config">
          LLM é…ç½® LLM Config
        </button>
        <button class="nav-btn" id="nav-config">è®¾ç½® Settings</button>
      </div>
      <div class="sidebar-bottom">
        <span style="font-size: 13px; color: #94a3b8">v1.0</span>
      </div>
    </div>
    <div class="main-content">
      <div class="main-inner">
        <div id="page-workbench">
          <h1 id="page-title" style="
                text-align: center;
                font-size: 2.2rem;
                font-weight: 700;
                color: #1e293b;
                margin: 0 0 24px 0;
              ">
            è§†é¢‘ç¿»è¯‘é…éŸ³<br />
            Video Translation &amp; Dubbing
          </h1>

          <!-- Tab Navigation -->
          <div class="tabs-nav">
            <button class="tab-btn active" id="tab-btn-create" onclick="switchTab('create')">
              âœ¨ æ–°å»ºä»»åŠ¡ New Task
            </button>
            <button class="tab-btn" id="tab-btn-history" onclick="switchTab('history')">
              ğŸ—‚ï¸ å†å²è®°å½• History
            </button>
          </div>

          <!-- Tab Content: Create Task -->
          <div id="tab-create-task">
            <!-- è§†é¢‘è¾“å…¥åŒºåŸŸ -->
            <div class="card">
              <h3 class="card-title">1. è§†é¢‘æºè®¾ç½® Video Source Settings</h3>
              <div class="form-group">
                <div class="radio-group">
                  <label class="radio-item">
                    <input type="radio" name="inputType" value="url" checked />
                    <span>è¾“å…¥é“¾æ¥ Paste a link</span>
                  </label>
                  <label class="radio-item">
                    <input type="radio" name="inputType" value="file" />
                    <span>æœ¬åœ°ä¸Šä¼  Upload a file</span>
                  </label>
                </div>
              </div>

              <div class="form-group" id="urlInputContainer">
                <label class="form-label">è§†é¢‘åœ°å€ Video URLs:<br><span
                    style="font-weight:normal;font-size:12px;color:#666">(One per line)</span></label>
                <textarea id="urlInput" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥ Paste links here (One per line)" class="form-input"
                  style="min-height: 80px; font-family: monospace;"></textarea>
              </div>

              <div class="hidden" id="fileInputContainer" style="display: block;">
                <!-- Video Upload Row -->
                <div class="form-group" style="margin-bottom: 20px;">
                  <label class="form-label" style="min-width: 160px;">ä¸Šä¼ è§†é¢‘ Upload Video:</label>
                  <input type="file" id="fileInput" accept="video/*" multiple class="form-input" />
                </div>

                <!-- Audio Upload Row (Separate Block) -->
                <div style="display: block; border-top: 1px dashed #e5e7eb; padding-top: 16px; margin-top: 10px;">
                  <label class="form-label" style="text-align: left; display: block; margin-bottom: 8px; width: 100%;">
                    (å¯é€‰) ä¸Šä¼ ç‹¬ç«‹éŸ³é¢‘ (Optional) Upload Separate Audio:
                  </label>
                  <div class="subtitle" style="margin-bottom: 8px; color: #666; font-size: 13px; line-height: 1.5;">
                    è‹¥ä¸Šä¼ æ­¤é¡¹ï¼Œå°†ç›´æ¥ä½¿ç”¨è¯¥éŸ³é¢‘ï¼Œä¸å†ä»è§†é¢‘æå–ã€‚è·³è¿‡ä¸‹è½½è€—æ—¶ã€‚<br>
                    If uploaded, this audio will be used directly, skipping video extraction. Faster processing.
                  </div>
                  <input type="file" id="audioFileInput" accept="audio/*" class="form-input"
                    style="width: 100%; box-sizing: border-box;" />
                </div>

                <div id="uploadStatus" class="loading hidden" style="margin-top: 12px;">
                  æ­£åœ¨ä¸Šä¼ ... Uploading...
                </div>
              </div>
            </div>

            <!-- å­—å¹•è®¾ç½®åŒºåŸŸ -->
            <div class="card">
              <h3 class="card-title">2. å­—å¹•è®¾ç½® Subtitle Settings</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">æºè¯­è¨€<br />Original Language:</label>
                  <select id="source-language" class="form-select">
                    <option value="zh_cn">ç®€ä½“ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="tr">TÃ¼rkÃ§e</option>
                    <option value="de">Deutsch</option>
                    <option value="ko">í•œêµ­ì–´</option>
                    <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº</option>
                    <option value="ms">Bahasa Melayu</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">ç¿»è¯‘æˆ<br />Translate To:</label>
                  <select id="target-language" class="form-select">
                    <option value="zh_cn">ç®€ä½“ä¸­æ–‡</option>
                    <option value="zh_tw">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="id">bahasa Indonesia</option>
                    <option value="ms">Bahasa Melayu</option>
                    <option value="th">à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</option>
                    <option value="vi">Tiáº¿ng Viá»‡t</option>
                    <option value="fil">Wikang Filipino</option>
                    <option value="ko">í•œêµ­ì–´</option>
                    <option value="ar">Ø§ÙÙ„Ù’Ø¹ÙØ±ÙØ¨ÙÙŠÙÙ‘Ø©Ù</option>
                    <option value="fr">FranÃ§ais</option>
                    <option value="de">Deutsch</option>
                    <option value="it">Italiano</option>
                    <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº</option>
                    <option value="pt">PortuguÃªs</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                    <option value="bn">à¦¬à¦¾à¦‚à¦²à¦¾</option>
                    <option value="he">×¢×‘×¨×™×ª</option>
                    <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
                    <option value="af">Afrikaans</option>
                    <option value="sv">Svenska</option>
                    <option value="fi">Suomi</option>
                    <option value="da">Dansk</option>
                    <option value="no">Norsk</option>
                    <option value="nl">Nederlands</option>
                    <option value="el">ÎÎ­Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬;</option>
                    <option value="uk">Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
                    <option value="hu">Magyar nyelv</option>
                    <option value="pl">Polski</option>
                    <option value="tr">TÃ¼rkÃ§e</option>
                    <option value="sr">Ğ¡Ñ€Ğ¿ÑĞºĞ¸</option>
                    <option value="hr">Hrvatski</option>
                    <option value="cs">ÄeÅ¡tina</option>
                    <option value="pinyin">Pin yin</option>
                    <option value="sw">Kiswahili</option>
                    <option value="yo">Ã¨dÃ¨ YorÃ¹bÃ¡</option>
                    <option value="ha">Ù‡ÙØ±Ù’Ø´ÙœÙ† Ù‡ÙÙˆÙ’Ø³</option>
                    <option value="am">áŠ áˆ›áˆ­áŠ›</option>
                    <option value="om">afaan Oromoo</option>
                    <option value="is">Ãslenska</option>
                    <option value="lb">LÃ«tzebuergesch</option>
                    <option value="ca">CatalÃ </option>
                    <option value="ro">RomÃ¢nÃ£</option>
                    <option value="sk">SlovenÄina</option>
                    <option value="bs">Ğ‘Ğ¾ÑĞ°Ğ½ÑĞºĞ¸</option>
                    <option value="mk">ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸</option>
                    <option value="sl">SlovenÅ¡Äina</option>
                    <option value="bg">Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</option>
                    <option value="lv">Latviski</option>
                    <option value="lt">LietuviÅ¡kai</option>
                    <option value="et">Eesti keel</option>
                    <option value="mt">Malti</option>
                    <option value="sq">Shqip</option>
                    <option value="pa">à¨ªà©°à¨œà¨¾à¨¬à©€</option>
                    <option value="jv">ê¦§ê¦±ê¦—ê¦®</option>
                    <option value="ta">à®¤à®®à®¿à®´à¯</option>
                    <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
                    <option value="mr">à¤®à¤°à¤¾à¤ à¥€</option>
                    <option value="te">à°¤à±†à°²à±à°—à±</option>
                    <option value="ps">Ù¾ÚšØªÙˆ</option>
                    <option value="ln">LingÃ¡la</option>
                    <option value="ml">à´®à´²à´¯à´¾à´³à´‚</option>
                    <option value="cnh">å®¢å®¶è¯</option>
                    <option value="uz">OÊ»zbekcha</option>
                    <option value="kn">à²•à²¨à³à²¨à²¡</option>
                    <option value="or">à¬“à¬¡à¬¼à¬¿à¬†</option>
                    <option value="ig">Igbo</option>
                    <option value="zu">isiZulu</option>
                    <option value="xh">isiXhosa</option>
                    <option value="km">á—á¶áŸá¶ááŸ’á˜áŸ‚áš</option>
                    <option value="lo">àºàº²àºªàº²àº¥àº²àº§</option>
                    <option value="ka">áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜</option>
                    <option value="hy">Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶</option>
                    <option value="tg">Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£</option>
                    <option value="tk">TÃ¼rkmenÃ§e</option>
                    <option value="kk">ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ°</option>
                    <option value="ky">ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·Ñ‡Ğ°</option>
                    <option value="mn">ĞœĞ¾Ğ½Ğ³Ğ¾Ğ» Ñ…ÑĞ»</option>
                    <option value="gd">GÃ idhlig</option>
                    <option value="ga">Gaeilge</option>
                    <option value="cy">Cymraeg</option>
                    <option value="ba">Ğ‘Ğ°ÑˆÒ¡Ğ¾Ñ€Ñ‚ÑĞ°</option>
                    <option value="ceb">Bisaya</option>
                    <option value="ilo">Ilokano</option>
                    <option value="tt">Ğ¢Ğ°Ñ‚Ğ°Ñ€Ñ‡Ğ°</option>
                    <option value="pi">à¤ªà¤¾à¤´à¤¿</option>
                    <option value="rw">Ikinyarwanda</option>
                    <option value="be">Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞºĞ°Ñ</option>
                    <option value="mg">Malagasy</option>
                    <option value="tvl">Te Ggana Tuuvalu</option>
                    <option value="mh">Kajin MÌ§ajeÄ¼</option>
                    <option value="ch">Chamoru</option>
                    <option value="sm">Gagana Samoa</option>
                    <option value="to">Lea faka-Tonga</option>
                    <option value="mi">MÄori</option>
                    <option value="tpi">Tok Pisin</option>
                    <option value="cv">Ğ§Ó‘Ğ²Ğ°ÑˆĞ»Ğ°</option>
                    <option value="kv">ĞšĞ¾Ğ¼Ğ¸ ĞºÑ‹Ğ²</option>
                    <option value="gv">Gaelg</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="bilingual-toggle" checked />
                  <span>å¯ç”¨åŒè¯­å­—å¹• Bilingual Subtitles</span>
                </label>
                <select id="bilingual-position" class="form-select" style="width: 200px; margin-left: 16px">
                  <option value="top">ç¿»è¯‘åœ¨ä¸Š Translation Above</option>
                  <option value="bottom">ç¿»è¯‘åœ¨ä¸‹ Translation Below</option>
                </select>
              </div>

              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="filler-filter-toggle" checked />
                  <span>å¯ç”¨è¯­æ°”è¯è¿‡æ»¤ Tone Word Filtering</span>
                </label>
              </div>
            </div>

            <!-- é…éŸ³è®¾ç½®åŒºåŸŸ -->
            <div class="card">
              <h3 class="card-title">3. é…éŸ³è®¾ç½® Dubbing Settings</h3>
              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="voiceover-toggle" />
                  <span>å¯ç”¨é…éŸ³ Apply Dubbing</span>
                </label>
              </div>

              <!-- TTS æä¾›å•†é€‰æ‹© -->
              <div class="form-group" id="tts-provider-group" style="display: none;">
                <label class="form-label">TTS æä¾›å•†<br />TTS Provider:</label>
                <select id="tts-provider" class="form-select" style="width: 200px;">
                  <option value="doubao">ğŸ™ï¸ è±†åŒ…è¯­éŸ³ Doubao (æ¨èä¸­æ–‡)</option>
                  <option value="edge-tts">ğŸ†“ Edge TTS (å…è´¹)</option>
                  <option value="minimax">ğŸ”Š MiniMax</option>
                  <option value="openai">ğŸ¤– OpenAI TTS</option>
                  <option value="aliyun">â˜ï¸ é˜¿é‡Œäº‘è¯­éŸ³</option>
                </select>
              </div>

              <!-- éŸ³è‰²é€‰æ‹© -->
              <div class="form-group" id="voice-select-group" style="display: none;">
                <label class="form-label">é€‰æ‹©éŸ³è‰²<br />Select Voice:</label>
                <select id="voice-select" class="form-select" style="width: 300px;">
                  <!-- è±†åŒ…éŸ³è‰² -->
                  <optgroup label="è±†åŒ…è¯­éŸ³ Doubao (V3)" id="voice-group-doubao">
                    <option value="zh_female_cancan_mars_bigtts">ç¿ç¿ CanCan (æ ‡å‡†å¥³å£°)</option>
                    <option value="zh_female_wanqudashu_moon_bigtts">æ¹¾åŒºå¤§å” Wanqu Dashu (æ·±æƒ…ç”·å£°)</option>
                    <option value="zh_male_zhubajie_mars_bigtts">çŒªå…«æˆ’ Zhu Bajie (è¶£å‘³ç”·å£°)</option>
                    <option value="zh_female_naying_mars_bigtts">é‚£è‹± Na Ying (ç›´çˆ½å¥³å£°)</option>
                    <option value="zh_female_ganmaodianyin_mars_bigtts">æ„Ÿå†’ç”µéŸ³ Sick Electro (ç‰¹è‰²å¥³å£°)</option>
                  </optgroup>
                  <!-- Edge TTS éŸ³è‰² -->
                  <optgroup label="Edge TTS" id="voice-group-edge-tts" style="display: none;">
                    <option value="zh-CN-XiaoxiaoNeural">æ™“æ™“ (å¥³å£°)</option>
                    <option value="zh-CN-YunxiNeural">äº‘å¸Œ (ç”·å£°)</option>
                    <option value="zh-CN-YunjianNeural">äº‘å¥ (ç”·å£°)</option>
                    <option value="zh-CN-XiaoyiNeural">æ™“ä¾ (å¥³å£°)</option>
                    <option value="en-US-JennyNeural">Jenny (English Female)</option>
                    <option value="en-US-GuyNeural">Guy (English Male)</option>
                  </optgroup>
                  <!-- MiniMax éŸ³è‰² -->
                  <optgroup label="MiniMax" id="voice-group-minimax" style="display: none;">
                    <option value="male-qn-qingse">é’æ¶©ç”·å£°</option>
                    <option value="female-shaonv">å°‘å¥³éŸ³</option>
                    <option value="male-qn-jingying">ç²¾è‹±ç”·å£°</option>
                    <option value="female-yujie">å¾¡å§éŸ³</option>
                  </optgroup>
                  <!-- OpenAI éŸ³è‰² -->
                  <optgroup label="OpenAI" id="voice-group-openai" style="display: none;">
                    <option value="alloy">Alloy</option>
                    <option value="echo">Echo</option>
                    <option value="fable">Fable</option>
                    <option value="onyx">Onyx</option>
                    <option value="nova">Nova</option>
                    <option value="shimmer">Shimmer</option>
                  </optgroup>
                </select>
                <span class="hint" id="voice-hint">æ¨èç”¨äºä¸­æ–‡é…éŸ³</span>
              </div>

              <!-- è‡ªå®šä¹‰éŸ³è‰²ä»£ç  (é«˜çº§) -->
              <div class="form-group" id="custom-voice-group" style="display: none;">
                <label class="form-label">è‡ªå®šä¹‰éŸ³è‰²ä»£ç <br />Custom Voice Code:</label>
                <input type="text" id="voiceover-voice" placeholder="å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨ä¸Šæ–¹é€‰æ‹©" class="form-input"
                  style="width: 250px" />
                <span class="hint">ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰</span>
              </div>

              <!-- ä¿ç•™èƒŒæ™¯éŸ³ä¹æç¤º -->
              <div class="form-group" id="bgm-info" style="display: none;">
                <div
                  style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 20px;">ğŸµ</span>
                  <div>
                    <div style="font-weight: 600; color: #10b981;">ä¿ç•™èƒŒæ™¯éŸ³ä¹æ¨¡å¼</div>
                    <div style="font-size: 12px; color: #8599B1;">é…éŸ³æ—¶å°†è‡ªåŠ¨åˆ†ç¦»åŸè§†é¢‘çš„äººå£°å’ŒèƒŒæ™¯éŸ³ä¹ï¼Œä»…æ›¿æ¢äººå£°éƒ¨åˆ†</div>
                  </div>
                </div>
              </div>

              <!-- éŸ³è‰²å…‹éš† (ç«å±±) -->
              <div class="form-group" id="voice-clone-group" style="display: none;">
                <label class="form-label">éŸ³è‰²å…‹éš† SpeakerID<br />Voice Clone SpeakerID (S_*):</label>
                <input type="text" id="voice-clone-speaker-id" placeholder="å¿…å¡«ï¼Œä¾‹å¦‚ S_xxxxï¼ˆä»ç«å±±æ§åˆ¶å°è·å–ï¼‰" class="form-input"
                  style="width: 300px" />
                <div style="height: 10px;"></div>
                <label class="form-label">é€‰æ‹©éŸ³è‰²å…‹éš†æ ·æœ¬<br />Select Voice Clone Sample:</label>
                <input type="file" id="voiceFileInput" accept="audio/*" class="form-input" style="width: 300px" />
                <span class="hint">ï¼ˆç«å±±å£°éŸ³å¤åˆ» ICL2.0ï¼šä¼šä¸Šä¼ æ ·æœ¬å¹¶è®­ç»ƒ/æ›´æ–°è¯¥ SpeakerIDï¼‰</span>
              </div>
            </div>

            <!-- è§†é¢‘åˆæˆè®¾ç½® -->
            <div class="card">
              <h3 class="card-title">4. è§†é¢‘åˆæˆè®¾ç½® Composition Settings</h3>
              <div class="form-group">
                <label class="checkbox-item">
                  <input type="checkbox" id="embed-subtitle-toggle" />
                  <span>åˆæˆ Composite</span>
                </label>
                <select id="embed-subtitle" class="form-select" style="width: 200px; margin-left: 16px" disabled
                  autocomplete="off">
                  <option value="horizontal">æ¨ªå±è¾“å‡º Landscapeï¼ˆ16ï¼š9ï¼‰</option>
                  <option value="vertical">ç«–å±è¾“å‡º Portraitï¼ˆ9:16ï¼‰</option>
                  <option value="all" selected>æ¨ªå±+ç«–å± (Landscape+Portrait)</option>
                </select>
                <script>
                  // Force default to 'all' on load to override browser restore
                  document.addEventListener("DOMContentLoaded", function () {
                    const sel = document.getElementById('embed-subtitle');
                    if (sel && sel.value === 'horizontal') sel.value = 'all';
                  });
                </script>
              </div>
              <div id="subtitle-text-inputs" class="hidden">
                <div class="form-group">
                  <label class="form-label">ä¸»æ ‡é¢˜ Main Title:</label>
                  <input type="text" id="subtitle-text-1"
                    placeholder="è¯·è¾“å…¥ç«–å±è§†é¢‘ä¸»æ ‡é¢˜ Please enter main title for vertical video" class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">å‰¯æ ‡é¢˜ Subtitle:</label>
                  <input type="text" id="subtitle-text-2"
                    placeholder="è¯·è¾“å…¥ç«–å±è§†é¢‘å‰¯æ ‡é¢˜ Please enter subtitle for vertical video" class="form-input" />
                </div>
              </div>
              <!-- æ‰§è¡ŒæŒ‰é’® -->
              <div class="action-area">
                <button type="button" id="executeButton" class="btn-primary">
                  å¼€å§‹ç¿»è¯‘ Start Translating
                </button>
              </div>

            </div> <!-- End of subtitle-composition-settings wrapper if any, actually just end of card -->
          </div>
        </div> <!-- End of tab-create-task -->

        <!-- Tab Content: History -->
        <div id="tab-history" class="hidden"
          style="display: none; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">
          <!-- Search and Filter Bar -->
          <div class="history-controls"
            style="display: flex; gap: 12px; align-items: center; padding: 12px 0; border-bottom: 1px solid #2E3A4B; margin-bottom: 12px; flex-shrink: 0;">
            <div style="flex: 1; position: relative;">
              <input type="text" id="history-search" placeholder="ğŸ” æœç´¢è§†é¢‘æ ‡é¢˜æˆ–URL... Search title or URL..."
                style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid #3A4859; background: #1A2332; color: #E8E9F5; font-size: 14px;"
                oninput="filterHistory()" />
            </div>
            <select id="history-page-size" onchange="changePageSize()"
              style="padding: 10px 16px; border-radius: 8px; border: 1px solid #3A4859; background: #1A2332; color: #E8E9F5; font-size: 14px; cursor: pointer;">
              <option value="5">5æ¡/é¡µ</option>
              <option value="10" selected>10æ¡/é¡µ</option>
              <option value="20">20æ¡/é¡µ</option>
              <option value="50">50æ¡/é¡µ</option>
            </select>
          </div>

          <!-- Scrollable History List Container -->
          <div id="history-list-container" style="flex: 1; overflow-y: auto; padding-right: 8px; min-height: 0;">
            <div id="history-list" style="padding-top: 0;"></div>
          </div>

          <!-- Pagination Controls -->
          <div id="history-pagination"
            style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-top: 1px solid #2E3A4B; margin-top: 12px; flex-shrink: 0;">
            <span id="pagination-info" style="color: #8599B1; font-size: 13px;">æ˜¾ç¤º 0-0 å…± 0 æ¡</span>
            <div style="display: flex; gap: 8px;">
              <button onclick="prevPage()" id="btn-prev-page" disabled
                style="padding: 8px 16px; border-radius: 6px; border: 1px solid #3A4859; background: #1A2332; color: #E8E9F5; cursor: pointer; font-size: 13px;">
                â—€ ä¸Šä¸€é¡µ
              </button>
              <span id="page-numbers" style="display: flex; gap: 4px;"></span>
              <button onclick="nextPage()" id="btn-next-page" disabled
                style="padding: 8px 16px; border-radius: 6px; border: 1px solid #3A4859; background: #1A2332; color: #E8E9F5; cursor: pointer; font-size: 13px;">
                ä¸‹ä¸€é¡µ â–¶
              </button>
            </div>
          </div>
        </div>

        <!-- Hidden Legacy Progress Section -->
        <div id="taskListSection" class="progress-section hidden" style="display:none!important">

          <!-- è¿›åº¦åŒºåŸŸ -->
          <!-- ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ -->
          <div id="taskListSection" class="progress-section hidden">
            <h4>ä»»åŠ¡åˆ—è¡¨ Task Queue</h4>
            <div style="overflow-x: auto;">
              <table
                style="width: 100%; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden;">
                <thead>
                  <tr style="background: #f1f5f9; color: #475569; text-align: left;">
                    <th style="padding: 12px 16px; width: 60px;">ID</th>
                    <th style="padding: 12px 16px;">Source</th>
                    <th style="padding: 12px 16px; width: 30%;">Progress</th>
                    <th style="padding: 12px 16px; width: 100px;">Status</th>
                    <th style="padding: 12px 16px; width: 120px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="taskListBody">
                  <!-- Dynamic Rows -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div id="llm-config" style="display: none">
          <div class="card">
            <h3 class="card-title">API ä¾›åº”å•†</h3>
            <p class="card-subtitle">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡å¿«é€Ÿè·³è½¬åˆ°å¯¹åº”å¹³å°è´­ä¹°API</p>

            <div class="provider-grid">
              <div class="provider-card qwen" id="provider-qwen">
                <div class="provider-icon">
                  <img src="./source/qwen-color.svg" alt="é€šä¹‰åƒé—®" width="24" height="24" />
                </div>
                <div class="provider-name">é€šä¹‰åƒé—® Qwen</div>
                <div class="provider-desc">é˜¿é‡Œäº‘å¤§æ¨¡å‹æœåŠ¡</div>
              </div>

              <div class="provider-card openai" id="provider-openai">
                <div class="provider-icon">
                  <img src="./source/openai.svg" alt="OpenAI" width="24" height="24" />
                </div>
                <div class="provider-name">OpenAI</div>
                <div class="provider-desc">GPTæ¨¡å‹APIæœåŠ¡</div>
              </div>

              <div class="provider-card deepseek" id="provider-deepseek">
                <div class="provider-icon">
                  <img src="./source/deepseek-color.svg" alt="DeepSeek" width="24" height="24" />
                </div>
                <div class="provider-name">DeepSeek</div>
                <div class="provider-desc">é«˜æ€§ä»·æ¯”AIæ¨¡å‹</div>
              </div>

              <div class="provider-card add" id="provider-add">
                <div class="provider-icon">
                  <span style="font-size: 20px; line-height: 24px">ï¼‹</span>
                </div>
                <div class="provider-name">æ–°å¢</div>
                <div class="provider-desc">æ·»åŠ è‡ªå®šä¹‰ä¾›åº”å•†</div>
              </div>
            </div>
          </div>

          <!-- LLM é…ç½® -->
          <div class="card">
            <h3 class="card-title">LLM é…ç½® LLM Config</h3>
            <div class="form-group">
              <label class="form-label">API Base URL:</label>
              <input type="url" id="llm-base-url" placeholder="https://api.openai.com/v1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">API Key:</label>
              <input type="password" id="llm-api-key" placeholder="sk-..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">æ¨¡å‹åç§° Model name:</label>
              <input type="text" id="llm-model" value="gpt-3.5-turbo" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">æ”¯æŒæ¨¡å‹ Supported models:</label>
              <select id="llm-model-suggest" class="form-select">
                <option value="">è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</option>
              </select>
            </div>
          </div>

          <!-- ä½¿ç”¨æŒ‡å— -->
          <div class="card">
            <h3 class="card-title">ä½¿ç”¨æŒ‡å—</h3>
            <p class="card-subtitle">LLM APIé…ç½®è¯´æ˜ï¼ˆå¯å¤åˆ¶æ–‡æœ¬ï¼‰</p>

            <div class="guide-content">
              <h4>1. API Base URLï¼š</h4>
              <ul>
                <li>OpenAIå®˜æ–¹ï¼š<code>https://api.openai.com/v1</code></li>
                <li>
                  é˜¿é‡Œäº‘ç™¾ç‚¼ï¼š<code>https://dashscope.aliyuncs.com/compatible-mode/v1</code>
                </li>
                <li>DeepSeekï¼š<code>https://api.deepseek.com/v1</code></li>
              </ul>

              <h4>2. API Keyï¼š</h4>
              <ul>
                <li>åœ¨å¯¹åº”å¹³å°çš„æ§åˆ¶å°ä¸­è·å–</li>
                <li>è¯·å¦¥å–„ä¿ç®¡ï¼Œé¿å…æ³„éœ²</li>
              </ul>

              <h4>3. æ¨¡å‹åç§°ï¼š</h4>
              <ul>
                <li>OpenAIï¼šgpt-3.5-turbo, gpt-4, gpt-4-turbo...</li>
                <li>é˜¿é‡Œäº‘ï¼šqwen-turbo, qwen-plus, qwen-max...</li>
                <li>DeepSeekï¼šdeepseek-chat, deepseek-coder...</li>
              </ul>

              <h4>4. ä½¿ç”¨å»ºè®®ï¼š</h4>
              <ul>
                <li>æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¨¡å‹</li>
                <li>æ³¨æ„APIè°ƒç”¨è´¹ç”¨</li>
              </ul>
            </div>
          </div>
        </div>
        <div id="page-config" style="display: none">
          <h1 style="
                text-align: center;
                font-size: 2.2rem;
                font-weight: 700;
                color: #1e293b;
                margin: 0 0 32px 0;
              ">
            åº”ç”¨é…ç½® Application Configuration
          </h1>

          <!-- Cookie ç®¡ç† -->
          <div class="card" id="cookie-management-card">
            <h3 class="card-title">ğŸª Cookie ç®¡ç† Cookie Management</h3>

            <!-- Cookie çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="cookie-status-bar" id="cookie-status-bar">
              <div class="cookie-status-indicator" id="cookie-status-indicator">
                <span class="cookie-status-dot" id="cookie-status-dot"></span>
                <span class="cookie-status-text" id="cookie-status-text">æ£€æµ‹ä¸­... Checking...</span>
              </div>
              <div class="cookie-status-details" id="cookie-status-details"></div>
            </div>

            <!-- æ“ä½œåŒºåŸŸ -->
            <div class="form-group">
              <label class="form-label">ä¸Šä¼  Cookie æ–‡ä»¶ Upload Cookie File:</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="file" id="cookie-file-input" accept=".txt" style="flex: 1;" class="form-input" />
                <button type="button" id="cookie-upload-btn" class="btn-secondary"
                  style="white-space: nowrap; padding: 8px 16px;">
                  ä¸Šä¼  Upload
                </button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">æˆ–ç²˜è´´ Cookie å†…å®¹ Or Paste Cookie Content:</label>
              <textarea id="cookie-paste-area" class="form-input" rows="5"
                placeholder="# Netscape HTTP Cookie File&#10;.youtube.com&#9;TRUE&#9;/&#9;TRUE&#9;1234567890&#9;__Secure-3PSID&#9;value..."
                style="font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" id="cookie-paste-btn" class="btn-secondary" style="padding: 8px 16px;">
                  ä¿å­˜ç²˜è´´å†…å®¹ Save Pasted Content
                </button>
                <button type="button" id="cookie-validate-btn" class="btn-secondary" style="padding: 8px 16px;">
                  éªŒè¯ Cookie Validate Cookie
                </button>
              </div>
            </div>

            <!-- ä½¿ç”¨è¯´æ˜ -->
            <details class="cookie-help-section">
              <summary style="cursor: pointer; color: #6366f1; font-weight: 500; padding: 8px 0;">
                ğŸ“– å¦‚ä½•è·å– Cookieï¼Ÿ How to get cookies?
              </summary>
              <div
                style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 8px; font-size: 13px; line-height: 1.8;">
                <p><strong>æ–¹æ³• Method:</strong></p>
                <ol style="padding-left: 20px; margin: 8px 0;">
                  <li>åœ¨ Chrome/Edge æµè§ˆå™¨å®‰è£… <strong>"Get cookies.txt LOCALLY"</strong> æ‰©å±•</li>
                  <li>ç™»å½• YouTube (ç¡®ä¿å¯ä»¥æ­£å¸¸è§‚çœ‹è§†é¢‘)</li>
                  <li>åœ¨ YouTube é¡µé¢ç‚¹å‡»æ‰©å±•å›¾æ ‡</li>
                  <li>ç‚¹å‡» <strong>"Export"</strong> å¯¼å‡º Netscape æ ¼å¼ Cookies</li>
                  <li>åœ¨ä¸Šæ–¹ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´å†…å®¹</li>
                </ol>
                <p style="color: #ef4444; margin-top: 8px;">
                  âš ï¸ Cookie é€šå¸¸åœ¨ <strong>1-3ä¸ªæœˆ</strong> åè¿‡æœŸï¼Œå±Šæ—¶éœ€è¦é‡æ–°å¯¼å‡ºã€‚
                  Cookie typically expires after <strong>1-3 months</strong>, re-export when needed.
                </p>
              </div>
            </details>
          </div>

          <!-- åº”ç”¨é…ç½® -->
          <div class="card">
            <h3 class="card-title">åº”ç”¨é…ç½® App Config</h3>
            <div class="form-group">
              <label class="form-label">åˆ†æ®µå¤„ç†æ—¶é•¿(åˆ†é’Ÿ) Segment duration (minutes):</label>
              <input type="number" id="segment-duration" value="5" min="1" max="30" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">è½¬å½•æœ€å¤§å¹¶è¡Œæ•°é‡ Transcribe parallel num:</label>
              <input type="number" id="transcribe-parallel" value="2" min="1" max="10" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">ç¿»è¯‘æœ€å¤§å¹¶è¡Œæ•°é‡ Translate parallel num:</label>
              <input type="number" id="translate-parallel" value="5" min="1" max="20" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">è½¬å½•æœ€å¤§å°è¯•æ¬¡æ•° Transcribe max attempts:</label>
              <input type="number" id="transcribe-max-attempts" value="3" min="1" max="10" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">ç¿»è¯‘æœ€å¤§å°è¯•æ¬¡æ•° Translate max attempts:</label>
              <input type="number" id="translate-max-attempts" value="3" min="1" max="20" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">æ¯ä¸ªå¥å­æœ€å¤§å­—ç¬¦æ•° Max sentence length:</label>
              <input type="number" id="max-sentence-length" value="100" min="1" max="200" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">ç½‘ç»œä»£ç†åœ°å€ proxy:</label>
              <input type="text" id="proxy" placeholder="http://127.0.0.1:7890" class="form-input" />
            </div>
          </div>

          <!-- æœåŠ¡å™¨é…ç½® -->
          <div class="card">
            <h3 class="card-title">æœåŠ¡å™¨é…ç½® Server Config</h3>
            <div class="form-group">
              <label class="form-label">æœåŠ¡å™¨åœ°å€ Server address:</label>
              <input type="text" id="server-host" value="127.0.0.1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">æœåŠ¡å™¨ç«¯å£ Server port:</label>
              <input type="number" id="server-port" value="8888" min="1" max="65535" class="form-input" />
            </div>
          </div>

          <!-- LLMé…ç½® -->
          <!-- <div class="card">
              <h3 class="card-title">LLM é…ç½® LLM Config</h3>
              <div class="form-group">
                <label class="form-label">API Base URL:</label>
                <input
                  type="url"
                  id="llm-base-url"
                  placeholder="https://api.openai.com/v1"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API Key:</label>
                <input
                  type="password"
                  id="llm-api-key"
                  placeholder="sk-..."
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label class="form-label">æ¨¡å‹åç§° Model name:</label>
                <input
                  type="text"
                  id="llm-model"
                  value="gpt-3.5-turbo"
                  class="form-input"
                />
              </div>
            </div> -->

          <!-- è¯­éŸ³è¯†åˆ«é…ç½® -->
          <div class="card">
            <h3 class="card-title">è¯­éŸ³è¯†åˆ«é…ç½® Transcribe Config</h3>
            <div class="form-group">
              <label class="form-label">æä¾›å•† Provider:</label>
              <select id="transcribe-provider" class="form-select">
                <option value="openai">OpenAI</option>
                <option value="fasterwhisper">FasterWhisper</option>
                <option value="whisperkit">WhisperKit</option>
                <option value="whispercpp">WhisperCpp</option>
                <option value="aliyun">é˜¿é‡Œäº‘</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">
                GPUåŠ é€Ÿ Enable Gpu Acceleration
                <span class="hint">ä»… FasterWhisper ç”Ÿæ•ˆ(Only FasterWhisper)</span>
              </label>
              <select id="gpu-acceleration" class="form-select">
                <option value="true">æ˜¯ Yes</option>
                <option value="false">å¦ No</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI Base URL:</label>
              <input type="url" id="openai-base-url" placeholder="https://api.openai.com/v1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI API Key:</label>
              <input type="password" id="openai-api-key" placeholder="sk-..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI æ¨¡å‹ Model:</label>
              <input type="text" id="openai-model" value="whisper-1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">FasterWhisper æ¨¡å‹ Model:</label>
              <input type="text" id="fasterwhisper-model" placeholder="base" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">WhisperKit æ¨¡å‹ Model:</label>
              <input type="text" id="whisperkit-model" placeholder="base" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">WhisperCpp æ¨¡å‹ Model:</label>
              <input type="text" id="whispercpp-model" placeholder="base" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Access Key ID:</label>
              <input type="text" id="aliyun-oss-key-id" placeholder="LTAI..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Access Key Secret:</label>
              <input type="password" id="aliyun-oss-key-secret" placeholder="..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Bucket Name:</label>
              <input type="text" id="aliyun-oss-bucket" placeholder="your-bucket-name" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘è¯­éŸ³ Aliyun Speech Access Key ID:</label>
              <input type="text" id="aliyun-speech-key-id" placeholder="LTAI..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘è¯­éŸ³ Aliyun Speech Access Key Secret:</label>
              <input type="password" id="aliyun-speech-key-secret" placeholder="..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘è¯­éŸ³ Aliyun Speech App Key:</label>
              <input type="text" id="aliyun-speech-app-key" placeholder="..." class="form-input" />
            </div>
          </div>

          <!-- TTSé…ç½® -->
          <div class="card">
            <h3 class="card-title">æ–‡æœ¬è½¬è¯­éŸ³é…ç½® TTS Config</h3>
            <div class="form-group">
              <label class="form-label">æä¾›å•† Provider:</label>
              <select id="tts-provider" class="form-select">
                <option value="openai">OpenAI</option>
                <option value="aliyun">é˜¿é‡Œäº‘</option>
                <option value="edge-tts">Edge TTS</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI Base URL:</label>
              <input type="url" id="tts-openai-base-url" placeholder="https://api.openai.com/v1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI API Key:</label>
              <input type="password" id="tts-openai-api-key" placeholder="sk-..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">OpenAI æ¨¡å‹ Model:</label>
              <input type="text" id="tts-openai-model" value="tts-1" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Access Key ID:</label>
              <input type="text" id="tts-aliyun-oss-key-id" placeholder="LTAI..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Access Key Secret:</label>
              <input type="password" id="tts-aliyun-oss-key-secret" placeholder="..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun OSS Bucket:</label>
              <input type="text" id="tts-aliyun-oss-bucket" placeholder="your-bucket-name" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun Speech Access Key ID:</label>
              <input type="text" id="tts-aliyun-speech-key-id" placeholder="LTAI..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun Speech Access Key Secret:</label>
              <input type="password" id="tts-aliyun-speech-key-secret" placeholder="..." class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">é˜¿é‡Œäº‘ Aliyun Speech App Key:</label>
              <input type="text" id="tts-aliyun-speech-app-key" placeholder="..." class="form-input" />
            </div>
          </div>

          <!-- ä¿å­˜æŒ‰é’® -->
          <div class="action-area">
            <button type="button" id="saveConfigButton" class="btn-primary">
              ä¿å­˜é…ç½® Save Configuration
            </button>
          </div>
        </div>
      </div>

      <!-- Smart Clipper Page -->
      <div id="page-smart-clipper" style="display: none; flex-direction: column; padding: 36px 48px;">
        <div class="card">
          <div class="card-title">æ™ºèƒ½è¯­ä¹‰åˆ‡ç‰‡ Smart Semantic Clipper</div>
          <div class="card-subtitle">åˆ©ç”¨ KIMI AI åˆ†æé•¿è§†é¢‘å­—å¹•ï¼Œè‡ªåŠ¨è¯†åˆ«è¯é¢˜å¹¶æ‹†åˆ†ä¸ºç‹¬ç«‹ä¸»é¢˜çŸ­è§†é¢‘ã€‚</div>

          <!-- Input Section -->
          <div id="sc-input-section">
            <div class="form-group">
              <label>è§†é¢‘é“¾æ¥ Video URL</label>
              <input type="text" id="sc-url-input" class="form-input" placeholder="è¾“å…¥ YouTube è§†é¢‘é“¾æ¥ (Enter YouTube URL)">
            </div>
            <div class="action-area">
              <button class="btn-primary" id="btn-sc-analyze">å¼€å§‹åˆ†æ Analyze</button>
            </div>
          </div>

          <!-- Loading Section -->
          <div id="sc-loading-section" class="hidden"
            style="flex-direction: column; align-items: center; padding: 40px;">
            <div class="loading" style="font-size: 1.2rem; margin-bottom: 16px;">æ­£åœ¨ä¸‹è½½å¹¶åˆ†æè¯­ä¹‰ Analyzing Semantics...</div>
            <div style="color: #6b7280;">é•¿è§†é¢‘å¯èƒ½éœ€è¦ 1-3 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾… (May take 1-3 mins)</div>
          </div>

          <!-- Result Section -->
          <div id="sc-result-section" class="hidden">
            <h3 style="margin-top:0; color:#1690FF;" id="sc-video-title">Video Title</h3>
            <div style="margin-bottom: 16px; color:#B8C3D1;">è¯·å‹¾é€‰æ‚¨æƒ³è¦ç”Ÿæˆçš„ç‰‡æ®µ (Select clips to process):</div>

            <div id="sc-clip-list" style="margin-bottom: 24px;">
              <!-- Clips rendered here -->
            </div>

            <div class="action-area" style="text-align: right;">
              <button class="btn-primary" id="btn-sc-submit">ç”Ÿæˆé€‰å®šç‰‡æ®µ Process Selected Clips</button>
            </div>
          </div>
        </div>
      </div>

      <div class="status-bar" id="status-bar">å°±ç»ª Ready</div>
    </div>
  </div>

  <script>
    // è·å–ç®€æ´çš„æ—¶é—´æ ¼å¼ (HH:MM) - ä½¿ç”¨ç”¨æˆ·æœ¬åœ°æ—¶åŒº
    function getSimpleTime() {
      return new Date().toLocaleTimeString(undefined, {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      });
    }

    // è·Ÿè¸ªå½“å‰æ´»è·ƒé¡µé¢
    let currentActivePage = "workbench"; // é»˜è®¤ä¸ºå·¥ä½œå°é¡µé¢

    // Tab åˆ‡æ¢é€»è¾‘
    const navBtns = document.querySelectorAll(".nav-btn");
    const pageWorkbench = document.getElementById("page-workbench");
    const pageConfig = document.getElementById("page-config");
    const pageLLMConfig = document.getElementById("llm-config");
    const pageSmartClipper = document.getElementById("page-smart-clipper");

    navBtns.forEach((btn) => {
      btn.onclick = async () => {
        const previousPage = currentActivePage;
        let newPage;
        if (btn.id === "nav-workbench") {
          newPage = "workbench";
        } else if (btn.id === "nav-llm-config") {
          newPage = "llm-config";
        } else if (btn.id === "nav-config") {
          newPage = "config";
        } else if (btn.id === "nav-smart-clipper") {
          newPage = "smart-clipper";
        }

        // å¦‚æœä»é…ç½®é¡µé¢åˆ‡æ¢åˆ°å·¥ä½œå°é¡µé¢ï¼Œè‡ªåŠ¨ä¿å­˜é…ç½®
        if (previousPage === "config" && newPage === "workbench") {
          console.log(
            "ä»é…ç½®é¡µé¢åˆ‡æ¢åˆ°å·¥ä½œå°ï¼Œè‡ªåŠ¨ä¿å­˜é…ç½®... Switching from config page to workbench, auto-saving configuration..."
          );
          try {
            await saveConfig(false, true); // ä¸æ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œæ ‡è®°ä¸ºè‡ªåŠ¨ä¿å­˜
          } catch (error) {
            console.error(
              "è‡ªåŠ¨ä¿å­˜é…ç½®å¤±è´¥ Auto-save configuration failed:",
              error
            );
          }
        }

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        navBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentActivePage = newPage;

        pageWorkbench.style.display = "none";
        pageConfig.style.display = "none";
        pageLLMConfig.style.display = "none";
        if (pageSmartClipper) pageSmartClipper.style.display = "none";

        if (newPage === "workbench") {
          pageWorkbench.style.display = "flex";
        } else if (newPage === "config") {
          pageConfig.style.display = "flex";
          // Reset workbench tab and load config
          if (typeof switchTab === 'function') switchTab('create');
          if (typeof loadConfig === 'function') loadConfig();
        } else if (newPage === "llm-config") {
          pageLLMConfig.style.display = "flex";
          // Reset workbench tab and load config
          if (typeof switchTab === 'function') switchTab('create');
          if (typeof loadConfig === 'function') loadConfig();
          // Initialize suggest
          const suggest = document.getElementById("llm-model-suggest");
          if (suggest) suggest.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
        } else if (newPage === "smart-clipper") {
          pageSmartClipper.style.display = "flex";
        }
      };
    });
  </script>
  <script>
    // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
    function addButtonClickEffect(button) {
      if (!button) return;
      button.addEventListener("click", function () {
        this.classList.add("clicked");
        setTimeout(() => {
          this.classList.remove("clicked");
        }, 500);
      });
    }

    // ä¾›åº”å•†ç‚¹å‡»å¡«å……é€»è¾‘
    function setProvider(baseUrl, models) {
      const baseInput = document.getElementById("llm-base-url");
      const modelInput = document.getElementById("llm-model");
      const suggest = document.getElementById("llm-model-suggest");
      if (baseInput) baseInput.value = baseUrl || "";
      if (suggest) {
        suggest.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
        (models || []).forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m;
          opt.textContent = m;
          suggest.appendChild(opt);
        });
        if (models && models.length > 0) {
          suggest.value = models[0];
          if (modelInput) modelInput.value = models[0];
        } else if (modelInput) {
          modelInput.value = "";
        }
      }
    }

    // æ¨¡å‹å»ºè®®é€‰æ‹©æ—¶åŒæ­¥åˆ°è¾“å…¥æ¡†
    document.addEventListener("DOMContentLoaded", () => {
      const suggest = document.getElementById("llm-model-suggest");
      if (suggest) {
        suggest.addEventListener("change", () => {
          const modelInput = document.getElementById("llm-model");
          if (modelInput && suggest.value) {
            modelInput.value = suggest.value;
          }
        });
      }

      // ä¾›åº”å•†å¡ç‰‡ç‚¹å‡»ç»‘å®š
      const qwen = document.getElementById("provider-qwen");
      const openai = document.getElementById("provider-openai");
      const deepseek = document.getElementById("provider-deepseek");
      const add = document.getElementById("provider-add");
      if (qwen) {
        qwen.onclick = () =>
          setProvider("https://dashscope.aliyuncs.com/compatible-mode/v1", [
            "qwen-turbo",
            "qwen-plus",
            "qwen-max",
          ]);
      }
      if (openai) {
        openai.onclick = () =>
          setProvider("https://api.openai.com/v1", [
            "gpt-4o-mini",
            "gpt-4o",
            "gpt-4.1-mini",
            "o3-mini",
          ]);
      }
      if (deepseek) {
        deepseek.onclick = () =>
          setProvider("https://api.deepseek.com/v1", [
            "deepseek-chat",
            "deepseek-coder",
            "DeepSeek-V3",
            "DeepSeek-R1",
          ]);
      }
      if (add) {
        add.onclick = () => setProvider("", []);
      }
    });

    // åŠ è½½é…ç½®æ•°æ®
    async function loadConfig() {
      try {
        const response = await fetch("/api/config", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });
        if (response.ok) {
          const result = await response.json();
          if (result.error === 0 && result.data) {
            populateConfigForm(result.data);
            console.log("é…ç½®åŠ è½½æˆåŠŸ Configuration loaded successfully");
          }
        }
      } catch (error) {
        console.log(
          "åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½® Failed to load configuration, using default config:",
          error
        );
      }
    }

    // å¡«å……é…ç½®è¡¨å•
    function populateConfigForm(configData) {
      // åº”ç”¨é…ç½®
      if (configData.app) {
        document.getElementById("segment-duration").value =
          configData.app.segmentDuration || 5;
        document.getElementById("transcribe-parallel").value =
          configData.app.transcribeParallelNum || 2;
        document.getElementById("translate-parallel").value =
          configData.app.translateParallelNum || 5;
        document.getElementById("transcribe-max-attempts").value =
          configData.app.transcribeMaxAttempts || 3;
        document.getElementById("translate-max-attempts").value =
          configData.app.translateMaxAttempts || 3;
        document.getElementById("max-sentence-length").value =
          configData.app.maxSentenceLength || 100;
        document.getElementById("proxy").value = configData.app.proxy || "";
      }

      // æœåŠ¡å™¨é…ç½®
      if (configData.server) {
        document.getElementById("server-host").value =
          configData.server.host || "127.0.0.1";
        document.getElementById("server-port").value =
          configData.server.port || 8888;
      }

      // LLMé…ç½®
      if (configData.llm) {
        document.getElementById("llm-base-url").value =
          configData.llm.baseUrl || "";
        document.getElementById("llm-api-key").value =
          configData.llm.apiKey || "";
        document.getElementById("llm-model").value =
          configData.llm.model || "gpt-3.5-turbo";
        // æ¸…ç©ºå»ºè®®æ¨¡å‹ä¸‹æ‹‰
        const suggest = document.getElementById("llm-model-suggest");
        if (suggest) {
          suggest.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</option>';
        }
      }

      // è½¬å½•é…ç½®
      if (configData.transcribe) {
        document.getElementById("gpu-acceleration").value =
          configData.transcribe.enableGpuAcceleration === true
            ? "true"
            : "false";
        document.getElementById("transcribe-provider").value =
          configData.transcribe.provider || "openai";
        if (configData.transcribe.openai) {
          document.getElementById("openai-base-url").value =
            configData.transcribe.openai.baseUrl || "";
          document.getElementById("openai-api-key").value =
            configData.transcribe.openai.apiKey || "";
          document.getElementById("openai-model").value =
            configData.transcribe.openai.model || "whisper-1";
        }
        if (configData.transcribe.fasterwhisper) {
          document.getElementById("fasterwhisper-model").value =
            configData.transcribe.fasterwhisper.model || "";
        }
        if (configData.transcribe.whisperkit) {
          document.getElementById("whisperkit-model").value =
            configData.transcribe.whisperkit.model || "";
        }
        if (configData.transcribe.whispercpp) {
          document.getElementById("whispercpp-model").value =
            configData.transcribe.whispercpp.model || "";
        }
        if (configData.transcribe.aliyun) {
          if (configData.transcribe.aliyun.oss) {
            document.getElementById("aliyun-oss-key-id").value =
              configData.transcribe.aliyun.oss.accessKeyId || "";
            document.getElementById("aliyun-oss-key-secret").value =
              configData.transcribe.aliyun.oss.accessKeySecret || "";
            document.getElementById("aliyun-oss-bucket").value =
              configData.transcribe.aliyun.oss.bucket || "";
          }
          if (configData.transcribe.aliyun.speech) {
            document.getElementById("aliyun-speech-key-id").value =
              configData.transcribe.aliyun.speech.accessKeyId || "";
            document.getElementById("aliyun-speech-key-secret").value =
              configData.transcribe.aliyun.speech.accessKeySecret || "";
            document.getElementById("aliyun-speech-app-key").value =
              configData.transcribe.aliyun.speech.appKey || "";
          }
        }
      }

      // TTSé…ç½®
      if (configData.tts) {
        document.getElementById("tts-provider").value =
          configData.tts.provider || "openai";
        if (configData.tts.openai) {
          document.getElementById("tts-openai-base-url").value =
            configData.tts.openai.baseUrl || "";
          document.getElementById("tts-openai-api-key").value =
            configData.tts.openai.apiKey || "";
          document.getElementById("tts-openai-model").value =
            configData.tts.openai.model || "tts-1";
        }
        if (configData.tts.aliyun) {
          if (configData.tts.aliyun.oss) {
            document.getElementById("tts-aliyun-oss-key-id").value =
              configData.tts.aliyun.oss.accessKeyId || "";
            document.getElementById("tts-aliyun-oss-key-secret").value =
              configData.tts.aliyun.oss.accessKeySecret || "";
            document.getElementById("tts-aliyun-oss-bucket").value =
              configData.tts.aliyun.oss.bucket || "";
          }
          if (configData.tts.aliyun.speech) {
            document.getElementById("tts-aliyun-speech-key-id").value =
              configData.tts.aliyun.speech.accessKeyId || "";
            document.getElementById("tts-aliyun-speech-key-secret").value =
              configData.tts.aliyun.speech.accessKeySecret || "";
            document.getElementById("tts-aliyun-speech-app-key").value =
              configData.tts.aliyun.speech.appKey || "";
          }
        }
      }
    }

    // æ”¶é›†é…ç½®è¡¨å•æ•°æ®çš„å‡½æ•°
    function collectConfigData() {
      return {
        app: {
          segmentDuration:
            parseInt(document.getElementById("segment-duration").value) || 5,
          transcribeParallelNum:
            parseInt(document.getElementById("transcribe-parallel").value) ||
            2,
          translateParallelNum:
            parseInt(document.getElementById("translate-parallel").value) ||
            5,
          transcribeMaxAttempts:
            parseInt(
              document.getElementById("transcribe-max-attempts").value
            ) || 3,
          translateMaxAttempts:
            parseInt(
              document.getElementById("translate-max-attempts").value
            ) || 3,
          maxSentenceLength:
            parseInt(document.getElementById("max-sentence-length").value) ||
            100,
          proxy: document.getElementById("proxy").value,
        },
        server: {
          host: document.getElementById("server-host").value,
          port:
            parseInt(document.getElementById("server-port").value) || 8888,
        },
        llm: {
          baseUrl: document.getElementById("llm-base-url").value,
          apiKey: document.getElementById("llm-api-key").value,
          model: document.getElementById("llm-model").value,
        },
        transcribe: {
          provider: document.getElementById("transcribe-provider").value,
          enableGpuAcceleration:
            document.getElementById("gpu-acceleration").value == true,
          openai: {
            baseUrl: document.getElementById("openai-base-url").value,
            apiKey: document.getElementById("openai-api-key").value,
            model: document.getElementById("openai-model").value,
          },
          fasterwhisper: {
            model: document.getElementById("fasterwhisper-model").value,
          },
          whisperkit: {
            model: document.getElementById("whisperkit-model").value,
          },
          whispercpp: {
            model: document.getElementById("whispercpp-model").value,
          },
          aliyun: {
            oss: {
              accessKeyId: document.getElementById("aliyun-oss-key-id").value,
              accessKeySecret: document.getElementById(
                "aliyun-oss-key-secret"
              ).value,
              bucket: document.getElementById("aliyun-oss-bucket").value,
            },
            speech: {
              accessKeyId: document.getElementById("aliyun-speech-key-id")
                .value,
              accessKeySecret: document.getElementById(
                "aliyun-speech-key-secret"
              ).value,
              appKey: document.getElementById("aliyun-speech-app-key").value,
            },
          },
        },
        tts: {
          provider: document.getElementById("tts-provider").value,
          openai: {
            baseUrl: document.getElementById("tts-openai-base-url").value,
            apiKey: document.getElementById("tts-openai-api-key").value,
            model: document.getElementById("tts-openai-model").value,
          },
          aliyun: {
            oss: {
              accessKeyId: document.getElementById("tts-aliyun-oss-key-id")
                .value,
              accessKeySecret: document.getElementById(
                "tts-aliyun-oss-key-secret"
              ).value,
              bucket: document.getElementById("tts-aliyun-oss-bucket").value,
            },
            speech: {
              accessKeyId: document.getElementById("tts-aliyun-speech-key-id")
                .value,
              accessKeySecret: document.getElementById(
                "tts-aliyun-speech-key-secret"
              ).value,
              appKey: document.getElementById("tts-aliyun-speech-app-key")
                .value,
            },
          },
        },
      };
    }

    // ä¿å­˜é…ç½®çš„å‡½æ•°
    function saveConfig(showSuccessAlert = true, isAutoSave = false) {
      const configData = collectConfigData();
      const statusPrefix = isAutoSave ? "è‡ªåŠ¨ä¿å­˜ Auto-save" : "ä¿å­˜ Save";

      // æ˜¾ç¤ºä¿å­˜çŠ¶æ€ Show save status
      document.getElementById("status-bar").textContent =
        `æ­£åœ¨${statusPrefix}é…ç½®... Saving configuration... - ` +
        getSimpleTime();

      return fetch("/api/config", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(configData),
      })
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
        })
        .then((data) => {
          // æ£€æŸ¥ä¸šåŠ¡é”™è¯¯ç 
          if (data.error === 0) {
            if (showSuccessAlert) {
              alert("é…ç½®å·²æˆåŠŸä¿å­˜ï¼ Configuration saved successfully!");
            }
            document.getElementById("status-bar").textContent =
              `é…ç½®å·²${statusPrefix} Configuration saved - ` +
              getSimpleTime();
            return true;
          } else {
            // æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯ Show specific error message from backend
            const errorMsg =
              data.msg || "ä¿å­˜é…ç½®å¤±è´¥ Failed to save configuration";
            if (showSuccessAlert || !isAutoSave) {
              alert(
                `${statusPrefix}é…ç½®å¤±è´¥ Configuration failed: ` + errorMsg
              );
            }
            document.getElementById("status-bar").textContent =
              `é…ç½®${statusPrefix}å¤±è´¥ Configuration failed - ` +
              getSimpleTime();
            console.error("é…ç½®éªŒè¯å¤±è´¥:", data);
            return false;
          }
        })
        .catch((error) => {
          console.error("ä¿å­˜é…ç½®é”™è¯¯ Save configuration error:", error);
          if (showSuccessAlert || !isAutoSave) {
            alert(
              `${statusPrefix}é…ç½®å¤±è´¥ Configuration failed: Network error or server exception`
            );
          }
          document.getElementById("status-bar").textContent =
            `é…ç½®${statusPrefix}å¤±è´¥ Configuration failed - ` +
            getSimpleTime();
          return false;
        });
    }

    // é…ç½®é¡µé¢é€»è¾‘
    const saveConfigButton = document.getElementById("saveConfigButton");
    if (saveConfigButton) {
      addButtonClickEffect(saveConfigButton);
      saveConfigButton.onclick = () => {
        saveConfig(true, false);
      };
    }

    // ===== Cookie ç®¡ç†é€»è¾‘ =====
    async function loadCookieStatus() {
      try {
        const res = await fetch("/api/cookie/status");
        const data = await res.json();
        if (data.error === 0 && data.data) {
          updateCookieStatusUI(data.data);
        }
      } catch (e) {
        console.error("åŠ è½½CookieçŠ¶æ€å¤±è´¥:", e);
      }
    }

    function updateCookieStatusUI(status) {
      const dot = document.getElementById("cookie-status-dot");
      const text = document.getElementById("cookie-status-text");
      const details = document.getElementById("cookie-status-details");
      if (!dot || !text) return;

      // Remove all status classes
      dot.className = "cookie-status-dot";

      if (status.status === "valid") {
        dot.classList.add("cookie-dot-valid");
        text.textContent = "âœ… " + status.statusMsg;
      } else if (status.status === "expiring_soon") {
        dot.classList.add("cookie-dot-warning");
        text.textContent = "âš ï¸ " + status.statusMsg;
      } else if (status.status === "expired") {
        dot.classList.add("cookie-dot-expired");
        text.textContent = "âŒ " + status.statusMsg;
      } else {
        dot.classList.add("cookie-dot-expired");
        text.textContent = "âŒ " + status.statusMsg;
      }

      if (details && status.exists) {
        let detailHtml = `<span>Cookieæ•°é‡: ${status.cookieCount}</span>`;
        detailHtml += ` | <span>æœ€åæ›´æ–°: ${status.lastModified}</span>`;
        if (status.earliestExpiry) {
          detailHtml += ` | <span>æœ€æ—©è¿‡æœŸ: ${status.earliestExpiry}</span>`;
        }
        details.innerHTML = detailHtml;
      } else if (details) {
        details.innerHTML = "";
      }
    }

    // Upload cookie file
    const cookieUploadBtn = document.getElementById("cookie-upload-btn");
    if (cookieUploadBtn) {
      cookieUploadBtn.onclick = async () => {
        const fileInput = document.getElementById("cookie-file-input");
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          alert("è¯·é€‰æ‹©Cookieæ–‡ä»¶ Please select a cookie file");
          return;
        }
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        try {
          cookieUploadBtn.disabled = true;
          cookieUploadBtn.textContent = "ä¸Šä¼ ä¸­... Uploading...";
          const res = await fetch("/api/cookie/upload", { method: "POST", body: formData });
          const data = await res.json();
          if (data.error === 0) {
            alert(data.data.message || "ä¸Šä¼ æˆåŠŸ Upload successful");
            fileInput.value = "";
            loadCookieStatus();
          } else {
            alert(data.msg || "ä¸Šä¼ å¤±è´¥ Upload failed");
          }
        } catch (e) {
          alert("ä¸Šä¼ å¤±è´¥ Upload failed: " + e.message);
        } finally {
          cookieUploadBtn.disabled = false;
          cookieUploadBtn.textContent = "ä¸Šä¼  Upload";
        }
      };
    }

    // Paste cookie content
    const cookiePasteBtn = document.getElementById("cookie-paste-btn");
    if (cookiePasteBtn) {
      cookiePasteBtn.onclick = async () => {
        const textarea = document.getElementById("cookie-paste-area");
        if (!textarea || !textarea.value.trim()) {
          alert("è¯·ç²˜è´´Cookieå†…å®¹ Please paste cookie content");
          return;
        }
        try {
          cookiePasteBtn.disabled = true;
          cookiePasteBtn.textContent = "ä¿å­˜ä¸­... Saving...";
          const res = await fetch("/api/cookie/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: textarea.value }),
          });
          const data = await res.json();
          if (data.error === 0) {
            alert(data.data.message || "ä¿å­˜æˆåŠŸ Save successful");
            textarea.value = "";
            loadCookieStatus();
          } else {
            alert(data.msg || "ä¿å­˜å¤±è´¥ Save failed");
          }
        } catch (e) {
          alert("ä¿å­˜å¤±è´¥ Save failed: " + e.message);
        } finally {
          cookiePasteBtn.disabled = false;
          cookiePasteBtn.textContent = "ä¿å­˜ç²˜è´´å†…å®¹ Save Pasted Content";
        }
      };
    }

    // Validate cookie
    const cookieValidateBtn = document.getElementById("cookie-validate-btn");
    if (cookieValidateBtn) {
      cookieValidateBtn.onclick = async () => {
        try {
          cookieValidateBtn.disabled = true;
          cookieValidateBtn.textContent = "éªŒè¯ä¸­... Validating...";
          const res = await fetch("/api/cookie/validate", { method: "POST" });
          const data = await res.json();
          if (data.error === 0) {
            alert("âœ… " + (data.data.message || "Cookieæœ‰æ•ˆ Cookie is valid"));
          } else {
            alert("âŒ " + (data.msg || "Cookieæ— æ•ˆ Cookie is invalid"));
          }
          loadCookieStatus();
        } catch (e) {
          alert("éªŒè¯å¤±è´¥ Validation failed: " + e.message);
        } finally {
          cookieValidateBtn.disabled = false;
          cookieValidateBtn.textContent = "éªŒè¯ Cookie Validate Cookie";
        }
      };
    }

    // Load cookie status when config page becomes visible
    loadCookieStatus();

    // è¡¨å•äº¤äº’é€»è¾‘
    const voiceoverToggleEl = document.getElementById("voiceover-toggle");
    if (voiceoverToggleEl) {
      voiceoverToggleEl.onchange = function () {
        const voiceInput = document.getElementById("voiceover-voice");
        if (voiceInput) voiceInput.disabled = !this.checked;
      };
    }

    const embedSubtitleToggleEl = document.getElementById(
      "embed-subtitle-toggle"
    );
    if (embedSubtitleToggleEl) {
      embedSubtitleToggleEl.onchange = function () {
        const embedSelect = document.getElementById("embed-subtitle");
        if (embedSelect) embedSelect.disabled = !this.checked;
      };
    }

    const embedSubtitleEl = document.getElementById("embed-subtitle");
    if (embedSubtitleEl) {
      embedSubtitleEl.onchange = function () {
        const textInputs = document.getElementById("subtitle-text-inputs");
        if (textInputs) {
          if (this.value === "vertical" || this.value === "all") {
            textInputs.classList.remove("hidden");
          } else {
            textInputs.classList.add("hidden");
          }
        }
      };
    }

    // è¾“å…¥æ–¹å¼åˆ‡æ¢
    document.querySelectorAll('input[name="inputType"]').forEach((radio) => {
      radio.addEventListener("change", () => {
        const urlContainer = document.getElementById("urlInputContainer");
        const fileContainer = document.getElementById("fileInputContainer");
        const fileInput = document.getElementById("fileInput");
        const urlInput = document.getElementById("urlInput");
        const executeButton = document.getElementById("executeButton");

        if (radio.value === "url") {
          if (urlContainer) urlContainer.classList.remove("hidden");
          if (fileContainer) fileContainer.classList.add("hidden");
          if (fileInput) fileInput.required = false;
          if (urlInput) urlInput.required = true;
          if (executeButton) executeButton.disabled = false;
        } else {
          if (urlContainer) urlContainer.classList.add("hidden");
          if (fileContainer) fileContainer.classList.remove("hidden");
          if (urlInput) urlInput.required = false;
          if (fileInput) fileInput.required = true;
          if (executeButton) executeButton.disabled = true;
        }
      });
    });
  </script>

  <script>
    const urlInputContainer = document.getElementById("urlInputContainer");
    const fileInputContainer = document.getElementById("fileInputContainer");
    const urlInput = document.getElementById("urlInput");
    const fileInput = document.getElementById("fileInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const voiceFileInput = document.getElementById("voiceFileInput");
    const executeButton = document.getElementById("executeButton");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const downloadLinks = document.getElementById("downloadLinks");

    // è·å–è¡¨å•å…ƒç´ 
    const translationToggle = document.getElementById("bilingual-toggle");
    const translationLanguage = document.getElementById("target-language");
    const bilingualToggle = document.getElementById("bilingual-toggle");
    const bilingualPosition = document.getElementById("bilingual-position");
    const voiceoverToggle = document.getElementById("voiceover-toggle");
    const voiceoverVoice = document.getElementById("voiceover-voice");
    const embedSubtitleVideoTypeToggle = document.getElementById(
      "embed-subtitle-toggle"
    );
    const embedSubtitleVideoType = document.getElementById("embed-subtitle");
    const embedSubtitle = document.getElementById("embed-subtitle");
    const subtitleTextInputs = document.getElementById(
      "subtitle-text-inputs"
    );
    const verticalMajorTitle = document.getElementById("subtitle-text-1");
    const verticalMinorTitle = document.getElementById("subtitle-text-2");

    const API_SUBMIT_URL = "/api/capability/subtitleTask";
    const API_PROGRESS_URL = "/api/capability/subtitleTask";
    const API_UPLOAD_URL = "/api/file";

    let uploadedVideoUrl = null;
    let uploadedAudioUrl = null;

    // æ›´æ–°çŠ¶æ€ï¼ˆå¯ç”¨æˆ–ç¦ç”¨è¡¨å•é¡¹ï¼‰ Update state (enable or disable form items)
    function updateFormState() {
      if (translationLanguage && translationToggle)
        translationLanguage.disabled = !translationToggle.checked;
      if (translationToggle && !translationToggle.checked) {
        if (bilingualToggle) bilingualToggle.checked = false;
        if (voiceoverToggle) voiceoverToggle.checked = false;
      }
      if (voiceoverToggle && translationToggle)
        voiceoverToggle.disabled = !translationToggle.checked;

      // Update visibility of TTS settings
      const ttsProviderGroup = document.getElementById("tts-provider-group");
      const voiceSelectGroup = document.getElementById("voice-select-group");
      const bgmInfo = document.getElementById("bgm-info");
      const voiceCloneGroup = document.getElementById("voice-clone-group");
      const customVoiceGroup = document.getElementById("custom-voice-group");

      const isDubbingEnabled = voiceoverToggle && voiceoverToggle.checked; // && !voiceoverToggle.disabled;

      if (ttsProviderGroup) ttsProviderGroup.style.display = isDubbingEnabled ? "block" : "none";
      if (voiceSelectGroup) voiceSelectGroup.style.display = isDubbingEnabled ? "block" : "none";
      if (bgmInfo) bgmInfo.style.display = isDubbingEnabled ? "block" : "none";
      if (customVoiceGroup) customVoiceGroup.style.display = isDubbingEnabled ? "block" : "none";

      // Handle provider specific visibility
      if (isDubbingEnabled) {
        const provider = document.getElementById("tts-provider").value;
        updateVoiceOptions(provider);

        if (voiceCloneGroup) {
          // Voice clone is implemented via Volcengine speaker_id (S_*). It works with Doubao provider.
          voiceCloneGroup.style.display = (provider === "doubao") ? "block" : "none";
        }
      } else {
        if (voiceCloneGroup) voiceCloneGroup.style.display = "none";
      }
      if (voiceFileInput && voiceoverToggle)
        voiceFileInput.disabled = !voiceoverToggle.checked;
    }

    // æäº¤è¡¨å•å‚æ•°
    function getParams() {
      const formData = {
        language: "zh_cn",
        origin_lang: document.getElementById("source-language")
          ? document.getElementById("source-language").value
          : "zh_cn",
        target_lang:
          translationToggle &&
            translationToggle.checked &&
            translationLanguage
            ? translationLanguage.value
            : "none",
        bilingual: bilingualToggle && bilingualToggle.checked ? 1 : 2,
        translation_subtitle_pos:
          bilingualPosition && bilingualPosition.value === "top" ? 1 : 2,
        tts: voiceoverToggle && voiceoverToggle.checked ? 1 : 2,
        modal_filter:
          document.getElementById("filler-filter-toggle") &&
            document.getElementById("filler-filter-toggle").checked
            ? 1
            : 2,
        embed_subtitle_video_type:
          embedSubtitleVideoTypeToggle &&
            embedSubtitleVideoTypeToggle.checked &&
            embedSubtitleVideoType
            ? embedSubtitleVideoType.value
            : "none",
      };

      if (formData.tts === 1) {
        const provider = document.getElementById("tts-provider").value;
        const voiceSelect = document.getElementById("voice-select");
        const customVoice = document.getElementById("voiceover-voice");

        formData.tts_provider = provider;

        // Priority: Custom Code > Selected Voice
        if (customVoice && customVoice.value) {
          formData.tts_voice_code = customVoice.value;
        } else if (voiceSelect && voiceSelect.value) {
          formData.tts_voice_code = voiceSelect.value;
        }

        // Voice clone (Volc) requires speaker_id (S_*) + reference audio
        const cloneSpeakerIdEl = document.getElementById("voice-clone-speaker-id");
        if (uploadedAudioUrl) {
          formData.tts_voice_clone_src_file_url = Array.isArray(uploadedAudioUrl)
            ? uploadedAudioUrl[0]
            : uploadedAudioUrl;

          // If user provided speaker id, prefer it as voice code for cloned voice.
          if (cloneSpeakerIdEl && cloneSpeakerIdEl.value) {
            formData.tts_voice_code = cloneSpeakerIdEl.value;
          }
        }
      }

      if (formData.target_lang === "ro2") {
        formData.target_lang = "ro";
      }

      // æ·»åŠ å­—å¹•æ–‡æœ¬åˆ°è¯·æ±‚å‚æ•°ä¸­
      if (
        embedSubtitleVideoTypeToggle &&
        embedSubtitleVideoTypeToggle.checked &&
        embedSubtitle &&
        (embedSubtitle.value === "vertical" || embedSubtitle.value === "all")
      ) {
        if (verticalMajorTitle)
          formData.vertical_major_title = verticalMajorTitle.value;
        if (verticalMinorTitle)
          formData.vertical_minor_title = verticalMinorTitle.value;
      }

      console.log("è¡¨å•æ•°æ®:", formData);
      return formData;
    }

    // äº‹ä»¶ç›‘å¬å™¨
    if (translationToggle) {
      translationToggle.addEventListener("change", () => {
        updateFormState();
      });
    }

    if (bilingualToggle) {
      bilingualToggle.addEventListener("change", () => {
        if (bilingualPosition)
          bilingualPosition.disabled = !bilingualToggle.checked;
      });
    }

    if (voiceoverToggle) {
      voiceoverToggle.addEventListener("change", () => {
        updateFormState();
      });
    }

    const ttsProviderSelect = document.getElementById("tts-provider");
    if (ttsProviderSelect) {
      ttsProviderSelect.addEventListener("change", () => {
        updateFormState();
      });
    }

    function updateVoiceOptions(provider) {
      const groups = [
        "voice-group-doubao",
        "voice-group-edge-tts",
        "voice-group-minimax",
        "voice-group-openai"
      ];

      // Hide all groups first
      groups.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = "none";
      });

      // Show selected provider group
      const groupMap = {
        "doubao": "voice-group-doubao",
        "edge-tts": "voice-group-edge-tts",
        "minimax": "voice-group-minimax",
        "openai": "voice-group-openai"
      };

      const activeGroupId = groupMap[provider];
      if (activeGroupId) {
        const activeGroup = document.getElementById(activeGroupId);
        if (activeGroup) {
          activeGroup.style.display = ""; // Reset to default (block/optgroup display)

          // If current selected option is hidden, select the first option of the active group
          const currentSelect = document.getElementById("voice-select");
          const currentOption = currentSelect.options[currentSelect.selectedIndex];

          // Check if current option belongs to active group
          if (currentOption.parentNode !== activeGroup) {
            // Select first option of active group
            const firstOption = activeGroup.querySelector('option');
            if (firstOption) {
              currentSelect.value = firstOption.value;
            }
          }
        }
      }
    }

    if (embedSubtitle) {
      embedSubtitle.addEventListener("change", () => {
        const selectedValue = embedSubtitle.value;
        if (subtitleTextInputs) {
          if (selectedValue === "vertical" || selectedValue === "all") {
            subtitleTextInputs.classList.remove("hidden");
          } else {
            subtitleTextInputs.classList.add("hidden");
          }
        }
      });
    }

    // å¤„ç†è§†é¢‘ä¸Šä¼ 
    if (fileInput) {
      fileInput.addEventListener("change", async () => {
        if (fileInput.files.length === 0) return;

        if (uploadStatus) uploadStatus.classList.remove("hidden");
        if (executeButton) executeButton.disabled = true;

        const formData = new FormData();
        for (const file of fileInput.files) {
          formData.append("file", file);
        }

        try {
          const response = await fetch(API_UPLOAD_URL, {
            method: "POST",
            body: formData,
          });
          if (!response.ok)
            throw new Error("è§†é¢‘ä¸Šä¼ å¤±è´¥ Video upload failed");
          const res = await response.json();
          const { error, data, msg } = res || {};
          if (error !== 0 && error !== 200) {
            throw new Error(
              msg || "ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯• Upload failed, please try again"
            );
          }
          uploadedVideoUrl = data.file_path;
          if (executeButton) executeButton.disabled = false;
        } catch (error) {
          console.error("è§†é¢‘ä¸Šä¼ å¤±è´¥ Video upload failed:", error);
          alert(error);
        } finally {
          if (uploadStatus) uploadStatus.classList.add("hidden");
        }
      });
    }

    // å¤„ç†éŸ³é¢‘ä¸Šä¼  (TTS clone source)
    if (voiceFileInput) {
      voiceFileInput.addEventListener("change", async () => {
        if (voiceFileInput.files.length === 0) return;

        const file = voiceFileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch(API_UPLOAD_URL, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("ä¸Šä¼ å¤±è´¥ Upload failed");
          const res = await response.json();
          const { error, data, msg } = res || {};
          if (error !== 0 && error !== 200) {
            throw new Error(
              msg || "ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯• Upload failed, please try again"
            );
          }
          uploadedAudioUrl = data.file_path;
          console.log(
            "éŸ³é¢‘ä¸Šä¼ æˆåŠŸ Audio upload successful:",
            uploadedAudioUrl
          );
        } catch (error) {
          console.error("éŸ³é¢‘ä¸Šä¼ å¤±è´¥ Audio upload failed:", error);
          alert(error);
        }
      });
    }

    // New: å¤„ç†åˆ†ç¦»éŸ³é¢‘ä¸Šä¼  (Separate Audio File)
    const audioFileInput = document.getElementById("audioFileInput");
    let uploadedSeparateAudioUrl = "";

    if (audioFileInput) {
      audioFileInput.addEventListener("change", async () => {
        if (audioFileInput.files.length === 0) return;

        if (uploadStatus) uploadStatus.classList.remove("hidden");
        if (executeButton) executeButton.disabled = true;

        const file = audioFileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch(API_UPLOAD_URL, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("éŸ³é¢‘ä¸Šä¼ å¤±è´¥ Audio upload failed");
          const res = await response.json();
          const { error, data, msg } = res || {};
          if (error !== 0 && error !== 200) {
            throw new Error(msg || "ä¸Šä¼ å¤±è´¥ Upload failed");
          }
          uploadedSeparateAudioUrl = data.file_path; // Only used in file input mode
          console.log("ç‹¬ç«‹éŸ³é¢‘ä¸Šä¼ æˆåŠŸ:", uploadedSeparateAudioUrl);
          alert("ç‹¬ç«‹éŸ³é¢‘ä¸Šä¼ æˆåŠŸ Separate Audio Uploaded");
        } catch (error) {
          console.error("ç‹¬ç«‹éŸ³é¢‘ä¸Šä¼ å¤±è´¥:", error);
          alert("ç‹¬ç«‹éŸ³é¢‘ä¸Šä¼ å¤±è´¥: " + error);
        } finally {
          if (uploadStatus) uploadStatus.classList.add("hidden");
          if (executeButton) executeButton.disabled = false;
        }
      });
    }

    // è¯·æ±‚å¯åŠ¨ä»»åŠ¡æ¥å£
    async function startTask(params) {
      try {
        const response = await fetch(API_SUBMIT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(params),
        });
        const data = await response.json();
        if (+data.error !== 0 && +data.error !== 200) {
          throw new Error(data.msg || "å¯åŠ¨ä»»åŠ¡å¤±è´¥");
        }
        return (data.data || {}).task_id || "";
      } catch (error) {
        alert(error);
        console.error("å¯åŠ¨ä»»åŠ¡å¤±è´¥:", error);
        return null;
      }
    }

    // è½®è¯¢ä»»åŠ¡è¿›åº¦æ¥å£
    async function pollTaskProgress(taskId) {
      try {
        let progress = 0;
        while (progress < 100) {
          const response = await fetch(
            `${API_PROGRESS_URL}?taskId=${taskId}`
          );
          const data = await response.json();
          console.log("progress response---:", data);
          if (+data.error !== 0 && +data.error !== 200) {
            if (executeButton) executeButton.disabled = false;
            throw new Error(data.msg || "æŸ¥è¯¢è¿›åº¦å¤±è´¥");
          }
          const responseData = data.data || {};
          progress = responseData.process_percent || 0;
          if (progressBar) {
            progressBar.style.width = progress + "%";
            progressBar.textContent = progress + "%";
          }
          if (progress >= 100) {
            await displayDownloadLinks(
              responseData.subtitle_info || [],
              responseData.speech_download_url || "",
              responseData.task_id || "",
              embedSubtitleVideoTypeToggle &&
                embedSubtitleVideoTypeToggle.checked
                ? embedSubtitleVideoType.value
                : "none"
            );
            if (executeButton) executeButton.disabled = false;
            // æ˜¾ç¤ºoutputè·¯å¾„è¯´æ˜
            if (downloadLinks) {
              const tips = document.createElement("div");
              tips.textContent =
                "è‹¥éœ€è¦æŸ¥çœ‹åˆæˆçš„è§†é¢‘æˆ–è€…æ–‡å­—ç¨¿ï¼Œè¯·åˆ°è½¯ä»¶ç›®å½•ä¸‹çš„/output/tasks/" +
                responseData.task_id +
                "/output ç›®å½•ä¸‹æŸ¥çœ‹ã€‚";
              tips.style.marginTop = "10px";
              tips.style.color = "#666";
              tips.style.fontSize = "14px";
              downloadLinks.parentNode.appendChild(tips);
            }
            return;
          }
          await new Promise((resolve) => setTimeout(resolve, 5000));
        }
      } catch (error) {
        alert(error);
        if (executeButton) executeButton.disabled = false;
        console.error("æŸ¥è¯¢è¿›åº¦å¤±è´¥:", error);
      }
    }

    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
    async function displayDownloadLinks(
      urls,
      speechUrl,
      taskId,
      embedSubtitleType
    ) {
      console.log("ä¸‹è½½é“¾æ¥:", urls);
      console.log("åµŒå…¥å­—å¹•ç±»å‹:", embedSubtitleType);
      console.log("ä»»åŠ¡ID:", taskId);
      if (!downloadLinks) return;

      downloadLinks.innerHTML = "";

      // æ˜¾ç¤ºå­—å¹•ä¸‹è½½é“¾æ¥
      urls.forEach(({ name, download_url }) => {
        const link = document.createElement("a");
        link.href = download_url;
        link.textContent = name;
        link.download = "";
        downloadLinks.appendChild(link);
      });

      // æ˜¾ç¤ºé…éŸ³ä¸‹è½½é“¾æ¥
      if (speechUrl) {
        const sArr = speechUrl.split("/");
        const sName = sArr[sArr.length - 1];
        const link = document.createElement("a");
        link.href = speechUrl;
        link.target = "_blank";
        link.textContent = `é…éŸ³ï¼š${sName}`;
        link.download = "";
        downloadLinks.appendChild(link);
      }

      // æ£€æŸ¥å¹¶æ˜¾ç¤ºåµŒå…¥å­—å¹•è§†é¢‘ä¸‹è½½é“¾æ¥
      if (taskId && embedSubtitleType && embedSubtitleType !== "none") {
        const checkAndAddVideoLink = async (
          videoType,
          fileName,
          displayName
        ) => {
          try {
            const response = await fetch(
              `/api/file/tasks/${taskId}/output/${fileName}`,
              {
                method: "HEAD",
              }
            );
            if (response.ok) {
              const link = document.createElement("a");
              link.href = `/api/file/tasks/${taskId}/output/${fileName}`;
              link.textContent = displayName;
              link.download = "";
              downloadLinks.appendChild(link);
            } else {
              // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ·»åŠ æç¤ºä¿¡æ¯
              const tip = document.createElement("div");
              tip.textContent = `${displayName}ï¼š ç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆ${videoType}è§†é¢‘`;
              tip.style.color = "#FF0000";
              tip.style.fontSize = "12px";
              tip.style.marginTop = "4px";
              tip.style.fontStyle = "italic";
              downloadLinks.appendChild(tip);
            }
          } catch (error) {
            console.error(`æ£€æŸ¥${fileName}æ–‡ä»¶å¤±è´¥:`, error);
            // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ·»åŠ æç¤ºä¿¡æ¯
            const tip = document.createElement("div");
            tip.textContent = `${displayName}ï¼šæ–‡ä»¶æ£€æŸ¥å¤±è´¥`;
            tip.style.color = "#FF0000";
            tip.style.fontSize = "12px";
            tip.style.marginTop = "4px";
            tip.style.fontStyle = "italic";
            downloadLinks.appendChild(tip);
          }
        };

        if (
          embedSubtitleType === "horizontal" ||
          embedSubtitleType === "all"
        ) {
          await checkAndAddVideoLink(
            "æ¨ªå±",
            "horizontal_embed.mp4",
            "æ¨ªå±è§†é¢‘ï¼šhorizontal_embed.mp4"
          );
        }

        if (embedSubtitleType === "vertical" || embedSubtitleType === "all") {
          await checkAndAddVideoLink(
            "ç«–å±",
            "vertical_embed.mp4",
            "ç«–å±è§†é¢‘ï¼švertical_embed.mp4"
          );
        }
      }

      downloadLinks.classList.remove("hidden");
    }

    // ä»»åŠ¡çŠ¶æ€ç®¡ç†
    const activeTasks = new Map(); // taskId -> { row: HTMLElement, interval: number }
    const taskStartTimes = new Map(); // taskId -> startTime (timestamp ms)

    // Format elapsed time as "Xåˆ†Yç§’" or "Xå°æ—¶Yåˆ†"
    function formatElapsedTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      if (hours > 0) {
        return `${hours}å°æ—¶${minutes}åˆ†`;
      } else if (minutes > 0) {
        return `${minutes}åˆ†${seconds}ç§’`;
      } else {
        return `${seconds}ç§’`;
      }
    }

    // --- V2 JS Logic ---

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-btn-${tab}`).classList.add('active');

      const tabCreate = document.getElementById('tab-create-task');
      const tabHistory = document.getElementById('tab-history');
      const pageWorkbench = document.getElementById('page-workbench');
      const tabsNav = document.querySelector('.tabs-nav');
      const pageTitle = document.getElementById('page-title');

      if (tab === 'create') {
        tabCreate.classList.remove('hidden');
        tabCreate.style.display = '';
        tabHistory.classList.add('hidden');
        tabHistory.style.display = 'none';

        // Remove history overrides
        document.body.classList.remove('history-mode'); // Reset global layout
        if (pageWorkbench) {
          pageWorkbench.classList.remove('history-view');
          // Clean up legacy inline styles if any
          pageWorkbench.style.padding = '';
          pageWorkbench.style.gap = '';
        }
        if (tabsNav) tabsNav.style.marginBottom = '';
        if (pageTitle) pageTitle.style.display = '';

      } else {
        tabCreate.classList.add('hidden');
        tabCreate.style.display = 'none';
        tabHistory.classList.remove('hidden');
        tabHistory.style.display = 'flex';

        // Apply history overrides via class
        document.body.classList.add('history-mode'); // Apply global layout changes
        if (pageWorkbench) {
          pageWorkbench.classList.add('history-view');
        }
        // Ensure inline styles are cleared so class takes precedence
        if (tabsNav) tabsNav.style.marginBottom = '';
        if (pageTitle) pageTitle.style.display = ''; // Handled by class now
      }
    }

    async function copySummary(taskId) {
      // Find the hidden summary data or fetch it if needed. 
      // For simplicity, we assume the text is stored in a data attribute or we fetch the summary.txt
      // Better approach: When loading history, we store summary text? 
      // Or easier: fetch the summary file content.
      try {
        const res = await fetch(`/api/file/tasks/${taskId}/output/summary.txt`);
        if (res.ok) {
          const text = await res.text();
          await navigator.clipboard.writeText(text);
          // Show toast or tooltip (using alert for now or custom toast)
          const btn = document.getElementById(`copy-btn-${taskId}`);
          const original = btn.textContent;
          btn.textContent = "âœ“ Copied";
          setTimeout(() => btn.textContent = original, 2000);
        } else {
          alert("Summary not available yet.");
        }
      } catch (e) {
        console.error(e);
        alert("Failed to copy summary");
      }
    }

    function createTaskCard(taskId, source) {
      const list = document.getElementById("history-list");
      const card = document.createElement("div");
      card.className = "task-card";
      card.id = `task-${taskId}`;
      // Deep mode override for dynamic cards
      card.style.background = "#232C38";
      card.style.border = "1px solid #2E3A4B";
      card.style.color = "#E8E9F5";

      card.innerHTML = `
        <img src="" class="task-cover hidden" id="cover-${taskId}" alt="Cover">
        <div class="task-info">
          <div class="task-title" title="${source}" id="title-${taskId}" style="color:#FFFFFF">${source.substring(0, 60)}...</div>
          <div class="task-meta">
             <span id="status-${taskId}" class="status-badge" style="background:#0A2F50;color:#1690FF">Running</span>
             <span id="progress-${taskId}" style="font-weight:bold; font-size:12px; color:#B8C3D1">0%</span>
             <span id="elapsed-${taskId}" style="font-size:11px; color:#B8C3D1; margin-left:6px;">â± 0ç§’</span>
             <span id="status-msg-${taskId}" class="status-msg" style="font-size:11px; color:#8599B1; margin-left:8px; font-style:italic">Waiting...</span>
             <button class="copy-btn hidden" id="copy-btn-${taskId}" onclick="copySummary('${taskId}')">ğŸ“‹ å¤åˆ¶ç®€ä»‹ Copy Summary</button>
          </div>
          <div class="progress-bar" style="height:4px; margin-top:8px; border-radius:2px; background:#151A23">
             <div class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
        <div class="task-actions" id="actions-${taskId}">
           <!-- Dynamic Actions -->
           <button onclick="deleteTask('${taskId}')" class="icon-btn delete" title="Delete">ğŸ—‘</button>
        </div>
      `;

      list.prepend(card);
      return card;
    }

    // Legacy mapping for compatibility if needed, but we should update callers.
    const createTaskRow = createTaskCard;


    function updateTaskRow(taskId, progress, status, downloadUrls = null, speechUrl = null, embedSubtitleType = null, statusMsg = null) {
      const card = document.getElementById(`task-${taskId}`);
      if (!card) return;

      // Update progress
      const bar = card.querySelector(".progress-fill");
      if (bar) bar.style.width = `${progress}%`;

      const progressText = document.getElementById(`progress-${taskId}`);
      if (progressText) progressText.innerText = `${progress}%`;

      // Update status message
      const msgEl = document.getElementById(`status-msg-${taskId}`);
      if (msgEl && statusMsg) msgEl.textContent = statusMsg;

      // Update status badge
      const badge = document.getElementById(`status-${taskId}`);
      if (status === "success" || progress >= 100) {
        if (badge) {
          badge.textContent = "Completed";
          badge.style.background = "#dcfce7";
          badge.style.color = "#15803d";
        }
        if (bar) bar.style.background = "#22c55e";
      } else if (status === "failed") {
        if (badge) {
          badge.textContent = "Failed";
          badge.style.background = "#fee2e2";
          badge.style.color = "#b91c1c";
        }
        if (bar) bar.style.background = "#ef4444";

        // Add retry button for failed tasks
        const actionContainer = document.getElementById(`actions-${taskId}`);
        if (actionContainer && !document.getElementById(`retry-${taskId}`)) {
          const retryBtn = document.createElement("button");
          retryBtn.id = `retry-${taskId}`;
          retryBtn.className = "icon-btn";
          retryBtn.title = "é‡è¯• Retry";
          retryBtn.innerHTML = "ğŸ”„";
          retryBtn.style.background = "#fef3c7";
          retryBtn.onclick = () => retryTask(taskId);
          actionContainer.insertBefore(retryBtn, actionContainer.firstChild);
        }
      }

      // Add actions and cover if complete
      if ((progress >= 100 || status === "success") && downloadUrls) {
        const actionContainer = document.getElementById(`actions-${taskId}`);
        // Clear existing actions except delete (or rebuild detailed)
        // Rebuild:
        actionContainer.innerHTML = "";

        // Separate links
        const subtitles = [];
        const covers = [];
        const summaries = [];

        downloadUrls.forEach(item => {
          const lowerName = item.name.toLowerCase();
          if (lowerName.includes("srt")) subtitles.push(item);
          else if (lowerName.includes("cover")) covers.push(item);
          else if (lowerName.includes("summary")) summaries.push(item);
        });

        // 0. Update Cover Image
        if (covers.length > 0) {
          const img = document.getElementById(`cover-${taskId}`);
          if (img) {
            img.src = covers[0].download_url;
            img.classList.remove('hidden');
          }
        }

        // 0. Show Copy Button
        if (summaries.length > 0) {
          const copyBtn = document.getElementById(`copy-btn-${taskId}`);
          if (copyBtn) copyBtn.classList.remove('hidden');
        }

        // 1. Preview Button (Video) - check which video file exists
        if (embedSubtitleType && embedSubtitleType !== "none") {
          // Find video files from downloadUrls
          const videoFiles = downloadUrls?.filter(info =>
            info.download_url?.includes('_embed.mp4')
          ) || [];

          if (videoFiles.length > 0) {
            const btn = document.createElement("a");
            btn.className = "icon-btn";
            btn.href = videoFiles[0].download_url;
            btn.target = "_blank";
            btn.title = "Preview Video";
            btn.innerHTML = "â–¶";
            actionContainer.appendChild(btn);
          }
        }

        // 2. SRT Buttons
        if (subtitles.length > 0) {
          // Pick one primary or list all? Let's just create one button for SRT
          const btn = document.createElement("a");
          btn.className = "icon-btn";
          btn.href = subtitles[0].download_url;
          btn.download = "";
          btn.title = "Download Subtitles";
          btn.innerHTML = "CC";
          actionContainer.appendChild(btn);
        }

        // 3. Summary Button
        if (summaries.length > 0) {
          const btn = document.createElement("a");
          btn.className = "icon-btn";
          btn.href = summaries[0].download_url;
          btn.download = "";
          btn.title = "Download Summary";
          btn.innerHTML = "TXT";
          actionContainer.appendChild(btn);
        }

        // 4. Retry Button (Regenerate)
        const retryBtn = document.createElement("button");
        retryBtn.onclick = () => retryTask(taskId);
        retryBtn.className = "icon-btn retry";
        retryBtn.title = "Regenerate/Retry";
        retryBtn.innerHTML = "ğŸ”„";
        actionContainer.appendChild(retryBtn);

        // 5. Delete Button
        const delBtn = document.createElement("button");
        delBtn.onclick = () => deleteTask(taskId);
        delBtn.className = "icon-btn delete";
        delBtn.title = "Delete Task";
        delBtn.innerHTML = "ğŸ—‘";
        actionContainer.appendChild(delBtn);
      }

      // Always add retry and delete buttons for failed tasks (outside downloadUrls check)
      const actionContainer = document.getElementById(`actions-${taskId}`);
      if (actionContainer && status === "failed") {
        // Clear and rebuild for failed tasks
        actionContainer.innerHTML = "";

        // Retry Button
        const retryBtn = document.createElement("button");
        retryBtn.onclick = () => retryTask(taskId);
        retryBtn.className = "icon-btn retry";
        retryBtn.title = "Retry Task";
        retryBtn.innerHTML = "ğŸ”„";
        actionContainer.appendChild(retryBtn);

        // Delete Button
        const delBtn = document.createElement("button");
        delBtn.onclick = () => deleteTask(taskId);
        delBtn.className = "icon-btn delete";
        delBtn.title = "Delete Task";
        delBtn.innerHTML = "ğŸ—‘";
        actionContainer.appendChild(delBtn);
      }
    }

    // è½®è¯¢å•ä¸ªä»»åŠ¡
    async function pollTask(taskId, embedType) {
      // Record start time for this task
      if (!taskStartTimes.has(taskId)) {
        taskStartTimes.set(taskId, Date.now());
      }

      const interval = setInterval(async () => {
        try {
          // Update elapsed time
          const startTime = taskStartTimes.get(taskId);
          if (startTime) {
            const elapsed = Date.now() - startTime;
            const elapsedEl = document.getElementById(`elapsed-${taskId}`);
            if (elapsedEl) elapsedEl.textContent = `â± ${formatElapsedTime(elapsed)}`;
          }

          const response = await fetch(`${API_PROGRESS_URL}?taskId=${taskId}`);
          const json = await response.json();
          if (+json.error !== 0 && +json.error !== 200) {
            updateTaskRow(taskId, 0, "failed");
            clearInterval(interval);
            taskStartTimes.delete(taskId);
            return;
          }

          const data = json.data || {};
          const pct = data.process_percent || 0;
          const msg = data.status_msg || "Processing...";
          updateTaskRow(taskId, pct, "running", null, null, null, msg);

          if (pct >= 100) {
            updateTaskRow(taskId, 100, "success", data.subtitle_info, data.speech_download_url, embedType, "Completed");
            clearInterval(interval);
            taskStartTimes.delete(taskId);
          }
        } catch (e) {
          console.error(e);
          clearInterval(interval);
          taskStartTimes.delete(taskId);
        }
      }, 3000); // 3 seconds poll
      activeTasks.set(taskId, interval);
    }

    // --- History & Delete Logic ---

    window.addEventListener("DOMContentLoaded", () => {
      loadHistory();
    });

    // --- History Pagination & Search State ---
    let allHistoryTasks = [];      // All tasks from API
    let filteredTasks = [];        // Tasks after search filter
    let currentPage = 1;
    let pageSize = 10;

    async function loadHistory() {
      try {
        const res = await fetch("/api/capability/history");
        const json = await res.json();
        if (json.error === 0 && json.data) {
          allHistoryTasks = json.data;
          filteredTasks = [...allHistoryTasks];
          currentPage = 1;
          renderHistoryPage();
        }
      } catch (e) {
        console.error("Failed to load history", e);
      }
    }

    function filterHistory() {
      const query = (document.getElementById("history-search").value || "").toLowerCase().trim();
      if (!query) {
        filteredTasks = [...allHistoryTasks];
      } else {
        filteredTasks = allHistoryTasks.filter(task => {
          const title = (task.title || "").toLowerCase();
          const translatedTitle = (task.translated_title || "").toLowerCase();
          const src = (task.video_src || "").toLowerCase();
          return title.includes(query) || translatedTitle.includes(query) || src.includes(query);
        });
      }
      currentPage = 1;
      renderHistoryPage();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById("history-page-size").value, 10) || 10;
      currentPage = 1;
      renderHistoryPage();
    }

    function goToPage(page) {
      currentPage = page;
      renderHistoryPage();
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderHistoryPage();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredTasks.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderHistoryPage();
      }
    }

    function renderHistoryPage() {
      const list = document.getElementById("history-list");
      list.innerHTML = "";

      const totalItems = filteredTasks.length;
      const totalPages = Math.ceil(totalItems / pageSize) || 1;
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, totalItems);
      const pageTasks = filteredTasks.slice(startIdx, endIdx);

      pageTasks.forEach(task => {
        // Map DB status to frontend status
        let status = "running";
        if (task.status === 2) status = "success";
        else if (task.status === 3) status = "failed";

        createTaskCard(task.task_id, task.video_src);

        // Prepare download URLs
        let downloadUrls = [];
        if (task.SubtitleInfos) {
          downloadUrls = task.SubtitleInfos.map(info => ({
            name: info.name,
            download_url: info.download_url || `/api/file/tasks/${task.task_id}/output/${info.name}`
          }));
        }
        if (task.cover) {
          const coverName = task.cover.split('/').pop();
          downloadUrls.push({ name: "cover", download_url: `/api/file/tasks/${task.task_id}/output/${coverName}` });
        }

        updateTaskRow(task.task_id, task.process_percent, status, downloadUrls, null, "horizontal", task.status_msg || "");
      });

      // Update pagination info
      document.getElementById("pagination-info").textContent =
        totalItems === 0 ? "æš‚æ— è®°å½•" : `æ˜¾ç¤º ${startIdx + 1}-${endIdx} å…± ${totalItems} æ¡`;

      // Update pagination buttons
      document.getElementById("btn-prev-page").disabled = currentPage <= 1;
      document.getElementById("btn-next-page").disabled = currentPage >= totalPages;

      // Render page numbers
      const pageNumbersEl = document.getElementById("page-numbers");
      pageNumbersEl.innerHTML = "";
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.onclick = () => goToPage(i);
        btn.style.cssText = `padding: 6px 12px; border-radius: 4px; border: 1px solid #3A4859; 
          background: ${i === currentPage ? '#1690FF' : '#1A2332'}; 
          color: ${i === currentPage ? '#FFF' : '#E8E9F5'}; 
          cursor: pointer; font-size: 13px;`;
        pageNumbersEl.appendChild(btn);
      }
    }

    window.deleteTask = async function (taskId) {
      if (!confirm("Are you sure you want to delete this task and all its files?")) return;
      try {
        const res = await fetch(`/api/capability/task/${taskId}`, { method: "DELETE" });
        const json = await res.json();
        if (json.error === 0) {
          const tr = document.getElementById(`task-${taskId}`);
          if (tr) tr.remove();
        } else {
          alert("Delete failed: " + json.msg);
        }
      } catch (e) {
        alert("Delete error: " + e);
      }
    }

    window.retryTask = async function (taskId) {
      if (!confirm("é‡è¯•æ­¤ä»»åŠ¡ï¼Ÿ Retry this task?")) return;
      try {
        const res = await fetch(`/api/capability/task/${taskId}/retry`, { method: "POST" });
        const json = await res.json();
        if (json.error === 0) {
          // Remove old card
          const oldCard = document.getElementById(`task-${taskId}`);
          if (oldCard) oldCard.remove();

          // Get new task info from response
          const newTasks = json.data || [];
          if (newTasks.length > 0) {
            const newTask = newTasks[0];
            createTaskCard(newTask.task_id, newTask.src || "Retried Task");
            pollTask(newTask.task_id, "horizontal");
            switchTab("history");
          }
          alert("ä»»åŠ¡å·²é‡æ–°æäº¤ Task resubmitted");
        } else {
          alert("é‡è¯•å¤±è´¥ Retry failed: " + json.msg);
        }
      } catch (e) {
        alert("é‡è¯•å¤±è´¥ Retry error: " + e);
      }
    }

    // --- Main Execution Handler ---

    if (executeButton) {
      addButtonClickEffect(executeButton);

      executeButton.addEventListener("click", async () => {
        console.log("å¼€å§‹ä»»åŠ¡æŒ‰é’®è¢«ç‚¹å‡»");

        // æ›´æ–°çŠ¶æ€æ 
        const statusBar = document.getElementById("status-bar");
        if (statusBar) {
          statusBar.textContent = "æ­£åœ¨æäº¤ä»»åŠ¡... submitting... - " + getSimpleTime();
        }

        // ... existing validation checks ...
        if (
          bilingualToggle &&
          !bilingualToggle.checked &&
          embedSubtitleVideoTypeToggle &&
          embedSubtitleVideoTypeToggle.checked
        ) {
          alert("åˆæˆå­—å¹•åµŒå…¥è§†é¢‘å¿…é¡»æ‰“å¼€åŒè¯­é€‰é¡¹");
          return;
        }

        const inputType = document.querySelector('input[name="inputType"]:checked');
        let urls = [];
        let isFile = false;

        // URL Mode: Parse multiline
        if (inputType.value === "url") {
          const rawVal = urlInput ? urlInput.value.trim() : "";
          if (!rawVal) { alert("è¯·è¾“å…¥è§†é¢‘é“¾æ¥"); return; }
          urls = rawVal.split('\n').map(u => u.trim()).filter(u => u.length > 0);
        } else if (inputType.value === "file") {
          // File logic remains singular for now or depends on uploadedVideoUrl implementation
          if (!uploadedVideoUrl) { alert("è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶"); return; }
          // uploadedVideoUrl might be array if multi-upload supported
          if (Array.isArray(uploadedVideoUrl)) urls = uploadedVideoUrl;
          else urls = [uploadedVideoUrl];
          isFile = true;
        }

        if (urls.length === 0) return;

        const params = getParams();
        const taskListSection = document.getElementById("taskListSection");
        if (taskListSection) taskListSection.classList.remove("hidden");

        // æ‰¹é‡æäº¤
        for (const url of urls) {
          const taskParams = { ...params, url: url };
          // If in file mode and separate audio is uploaded, attach it
          if (isFile && uploadedSeparateAudioUrl) {
            taskParams.audio_url = uploadedSeparateAudioUrl;
          }

          try {
            const taskId = await startTask(taskParams);
            if (taskId) {
              createTaskRow(taskId, isFile ? "Local File" : url);
              // Start concurrent polling
              pollTask(taskId, params.embed_subtitle_video_type);
            }
          } catch (e) {
            console.error("Submission failed for", url, e);
          }
        }

        if (statusBar) statusBar.textContent = `å·²æäº¤ ${urls.length} ä¸ªä»»åŠ¡ Submitted tasks`;
        switchTab('history');
      });
    }

    // åˆå§‹åŒ–æ—¶æ›´æ–°è¡¨å•çŠ¶æ€
    updateFormState();

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", function () {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é…ç½®");
      // å¦‚æœå½“å‰åœ¨é…ç½®é¡µé¢ï¼Œåˆ™åŠ è½½é…ç½®
      const configPage = document.getElementById("page-config");
      if (configPage && configPage.style.display !== "none") {
        loadConfig();
      }
    });
  </script>
  <script src="/static/js/smart_clipper.js"></script>
</body>

</html>
