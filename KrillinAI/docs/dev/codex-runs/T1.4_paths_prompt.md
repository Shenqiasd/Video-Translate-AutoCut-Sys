# Codex Task T1.4: Unify OutputDir/CacheDir/Storage to portable data/

Repo: `Video-Translate-AutoCut-Sys/KrillinAI`
Branch: `feat/desktop-native-step1-appcore`

## Goal

Windows portable-by-default build must write ALL runtime artifacts to exe-adjacent `data/` folder:
- config: `data/config/config.toml` (already done)
- logs: `data/logs/app.log` (already done)
- output artifacts: `data/output/...`
- cache: `data/cache/...`
- database/storage: `data/krillin.db` (currently hardcoded)
- tasks directory: should be under `data/output/tasks/...` or similar (choose canonical)

## Current problems

- Many places hardcode `./tasks` and `cache` relative paths.
- `internal/storage/db.go` hardcodes `data/krillin.db` but not via appdirs.
- HTTP file endpoints allow roots `tasks`, `uploads`, `static` and compute paths using `./tasks`.
- UI text shows `/tasks/<id>/output` relative to app dir.

## Requirements

- Use `internal/appdirs.Resolve()` as the single source of truth:
  - `dirs.OutputDir` and `dirs.CacheDir` should be used for artifacts.
- Define a canonical task base path derived from OutputDir, e.g.:
  - `TaskRoot = filepath.Join(OutputDir, "tasks")`
  - task base = `filepath.Join(TaskRoot, taskId)`
- Update server + service + handler path computations to use this.
- Update allowedRoots / path sanitization accordingly.
- Update desktop UI hints to point to the new folder.
- Update DB path: `filepath.Join(CacheDir, "krillin.db")` (or keep under data root; pick one and apply consistently).
- Add a smoke-ish test that ensures task path resolution is under OutputDir.
- `go test ./...` must pass.

## Files to inspect/change

- `internal/service/subtitle_service.go`
- `internal/handler/subtitle_task.go`
- `internal/api/subtitle.go`
- `internal/service/smart_clipper.go` (task directories)
- `internal/storage/db.go`
- any other `filepath.Join("tasks", ...)` uses

## Output

- Code changes + tests.
- Keep backward compatibility for non-Windows as much as possible.
